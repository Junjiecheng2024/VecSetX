
# Phase 1 åŸºç¡€æ¨¡å‹è®­ç»ƒå®æ–½è®°å½•

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº† VecSetX é¡¹ç›® Phase 1 (å¤šç±»å¿ƒè„ç»“æ„é‡å»º) çš„å®æ–½è¿‡ç¨‹ã€æ–‡ä»¶ä¿®æ”¹åŸå› åŠå…·ä½“ä¿®æ”¹å†…å®¹ã€‚

## 1. æ•°æ®å‡†å¤‡ (Data Preparation)

### æ–‡ä»¶: `prepare_data.py` (æ–°å¢)
*   **åŸå› **: åŸå§‹æ•°æ®ä¸º `.nii.gz` æ ¼å¼çš„åŒ»å­¦åˆ†å‰²æ©ç ï¼Œè€Œ VecSetX æ¨¡å‹è®­ç»ƒéœ€è¦åŒ…å«ç‚¹äº‘ã€SDF å€¼å’Œè¡¨é¢æ³•å‘é‡ï¼ˆå¯é€‰ï¼‰çš„ `.npz` æ ¼å¼æ•°æ®ã€‚æ­¤å¤–ï¼ŒPhase 1 è¦æ±‚è¿›è¡Œå¤šç±»é‡å»ºï¼Œå› æ­¤éœ€è¦åœ¨æ•°æ®ä¸­åŒ…å«ç±»åˆ«ä¿¡æ¯ã€‚
*   **ä¿®æ”¹å†…å®¹**:
    *   **ç½‘æ ¼æå–**: ä½¿ç”¨ `skimage.measure.marching_cubes` ä»åˆ†å‰²æ©ç ä¸­æå– 3D ç½‘æ ¼ã€‚
    *   **è¡¨é¢é‡‡æ ·**: å®ç°äº†åŸºäºç½‘æ ¼é¢ç§¯æƒé‡çš„è¡¨é¢ç‚¹é‡‡æ ·ï¼Œç¡®ä¿é‡‡æ ·ç‚¹å‡åŒ€åˆ†å¸ƒã€‚
    *   **ç±»åˆ«ç¼–ç **: æå–äº† 10 ä¸ªè§£å‰–ç»“æ„çš„ç±»åˆ«æ ‡ç­¾ï¼Œå¹¶å¯¹è¡¨é¢ç‚¹è¿›è¡Œäº† **One-hot ç¼–ç **ã€‚ç”Ÿæˆçš„è¡¨é¢ç‚¹æ•°æ®ç»´åº¦ä¸º `(N, 13)`ï¼Œå…¶ä¸­å‰ 3 ç»´ä¸ºåæ ‡ï¼Œå 10 ç»´ä¸ºç±»åˆ«æ ‡ç­¾ã€‚
    *   **SDF è®¡ç®—**: ä½¿ç”¨ `trimesh` å’Œ `rtree` (KDTree) è®¡ç®—ä½“ç§¯ç‚¹å’Œè¿‘è¡¨é¢ç‚¹çš„ç¬¦å·è·ç¦»å‡½æ•° (SDF) å€¼ã€‚ä¸ºäº†æé«˜é€Ÿåº¦ï¼Œä½¿ç”¨äº†æ³•å‘é‡è¿‘ä¼¼æ³•ã€‚
    *   **å½’ä¸€åŒ–**: å°†æ‰€æœ‰ç‚¹åæ ‡å½’ä¸€åŒ–åˆ° `[-1, 1]` èŒƒå›´ï¼Œä¸æ¨¡å‹è¾“å…¥è¦æ±‚ä¸€è‡´ã€‚

### æ–‡ä»¶: `create_csv.py` (æ–°å¢)
*   **åŸå› **: `Objaverse` æ•°æ®é›†åŠ è½½å™¨éœ€è¦ CSV æ–‡ä»¶æ¥ç´¢å¼•è®­ç»ƒå’ŒéªŒè¯æ•°æ®ã€‚
*   **ä¿®æ”¹å†…å®¹**: ç¼–å†™è„šæœ¬æ‰«ææ•°æ®ç›®å½•ï¼Œè‡ªåŠ¨ç”Ÿæˆ `train.csv` å’Œ `val.csv`ã€‚

## 2. æ¨¡å‹æ¶æ„ä¿®æ”¹ (Model Architecture)

### æ–‡ä»¶: `vecset/models/autoencoder.py`
*   **åŸå› **: åŸå§‹æ¨¡å‹ä»…æ”¯æŒ 3 ç»´åæ ‡è¾“å…¥ã€‚ä¸ºäº†å®ç°å¤šç±»é‡å»ºï¼Œæ¨¡å‹éœ€è¦èƒ½å¤Ÿæ¥æ”¶åŒ…å«ç±»åˆ«ä¿¡æ¯çš„ 13 ç»´è¾“å…¥ã€‚åŒæ—¶ï¼Œè§£ç å™¨çš„æŸ¥è¯¢ (Query) ä»ç„¶æ˜¯ 3 ç»´ç©ºé—´åæ ‡ã€‚
*   **ä¿®æ”¹å†…å®¹**:
    *   **å‚æ•°æ‰©å±•**: åœ¨ `VecSetAutoEncoder` åˆå§‹åŒ–å‡½æ•°ä¸­æ·»åŠ äº† `input_dim` å‚æ•°ï¼Œé»˜è®¤ä¸º 3ï¼ŒPhase 1 è®¾ç½®ä¸º 13ã€‚
    *   **åˆ†ç¦»åµŒå…¥å±‚**: å°†åŸæ¥çš„å•ä¸€ `point_embed` å±‚æ‹†åˆ†ä¸ºä¸¤ä¸ªï¼š
        *   `self.point_embed`: ç”¨äºç¼–ç å™¨è¾“å…¥ï¼Œè¾“å…¥ç»´åº¦ä¸º `input_dim` (13)ã€‚
        *   `self.query_embed`: ç”¨äºè§£ç å™¨æŸ¥è¯¢ï¼Œè¾“å…¥ç»´åº¦å›ºå®šä¸º 3 (ä»…åæ ‡)ã€‚
    *   **è§£ç é€»è¾‘**: åœ¨ `decode` æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ `self.query_embed` å¯¹æŸ¥è¯¢ç‚¹è¿›è¡Œç¼–ç ã€‚
    *   **ä¿®å¤é”™è¯¯**: ä¿®å¤äº†åœ¨ä»£ç é‡æ„è¿‡ç¨‹ä¸­å¼•å…¥çš„ `SyntaxError` (è¯­æ³•é”™è¯¯) å’Œ `IndentationError` (ç¼©è¿›é”™è¯¯)ï¼Œå¹¶é‡å†™äº† `VecSetAutoEncoder` ç±»ä»¥ç¡®ä¿ç»“æ„æ­£ç¡®ã€‚
    *   **æ¸…ç†ä»£ç **: ç§»é™¤äº†æœªä½¿ç”¨çš„ `fps` å¯¼å…¥ã€‚

## 3. å·¥å…·ç±»ä¸ä¾èµ–é€‚é… (Utils & Dependencies)

### æ–‡ä»¶: `vecset/models/utils.py`
*   **åŸå› **: è¿è¡Œç¯å¢ƒç¼ºå°‘ `torch_cluster` åº“ï¼Œå¯¼è‡´ `fps` (æœ€è¿œç‚¹é‡‡æ ·) æ— æ³•å¯¼å…¥ï¼Œé˜»ç¢äº†è®­ç»ƒè„šæœ¬è¿è¡Œã€‚
*   **ä¿®æ”¹å†…å®¹**:
    *   **æ·»åŠ å›é€€æœºåˆ¶**: åœ¨å¯¼å…¥ `fps` æ—¶æ·»åŠ äº† `try-except` å—ã€‚å¦‚æœå¯¼å…¥å¤±è´¥ï¼Œ`subsample` å‡½æ•°ä¼šè‡ªåŠ¨å›é€€åˆ° **éšæœºé‡‡æ · (Random Sampling)**ã€‚è¿™ä¿è¯äº†ä»£ç åœ¨ç¼ºå°‘ç‰¹å®šç¼–è¯‘åº“çš„ç¯å¢ƒä¸­ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚
    *   **æ¸…ç†ä»£ç **: ç§»é™¤äº†é‡å¤çš„å¯¼å…¥è¯­å¥ã€‚

## 4. æ•°æ®åŠ è½½ä¸å¤„ç† (Dataset Loader)

### æ–‡ä»¶: `vecset/utils/objaverse.py`
*   **åŸå› **: éœ€è¦åŠ è½½æ–°çš„åŒ…å«æ ‡ç­¾çš„æ•°æ®æ ¼å¼ï¼Œå¹¶è§£å†³åœ¨ç‰¹å®šæ•°æ®åˆ†å¸ƒä¸‹é‡‡æ ·å¤±è´¥çš„é—®é¢˜ã€‚
*   **ä¿®æ”¹å†…å®¹**:
    *   **åŠ è½½æ ‡ç­¾**: ä¿®æ”¹ `__getitem__` æ–¹æ³•ï¼Œä» `.npz` æ–‡ä»¶ä¸­è¯»å– `surface_labels`ï¼Œå¹¶å°†å…¶æ‹¼æ¥åˆ° `surface_points` ä¹‹åã€‚
    *   **ä¿®å¤ç´¢å¼•é”™è¯¯**: ä¿®å¤äº†ä½“ç§¯ç‚¹é‡‡æ ·æ—¶çš„ `IndexError`ã€‚åŸä»£ç ç›´æ¥ä½¿ç”¨å¸ƒå°”å¼ é‡ä½œä¸ºç´¢å¼•ï¼Œå¯¼è‡´ç»´åº¦ä¸åŒ¹é…ã€‚ä¿®æ”¹ä¸ºå…ˆå°†å¸ƒå°”å¼ é‡ `reshape(-1)` ä¸ºä¸€ç»´ï¼Œå†è¿›è¡Œç´¢å¼•ã€‚
    *   **å¢å¼ºé²æ£’æ€§**: åœ¨é‡‡æ ·ç‚¹æ•°ä¸è¶³ï¼ˆä¾‹å¦‚æ­£ SDF ç‚¹å¾ˆå°‘ï¼‰çš„æƒ…å†µä¸‹ï¼Œå°† `np.random.choice` çš„ `replace` å‚æ•°è®¾ç½®ä¸º `True` (æœ‰æ”¾å›é‡‡æ ·)ï¼Œé˜²æ­¢ç¨‹åºå› æ ·æœ¬ä¸è¶³è€Œå´©æºƒã€‚

## 5. è®­ç»ƒå¼•æ“ä¸æµç¨‹ (Training Engine & Main Script)

### æ–‡ä»¶: `vecset/engines/engine_ae.py`
*   **åŸå› **: è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°äº†ç»´åº¦ä¸åŒ¹é…çš„é”™è¯¯ï¼Œå¯¼è‡´ Loss æ— æ³•è®¡ç®—æˆ–æ¨¡å‹å‰å‘ä¼ æ’­å¤±è´¥ã€‚
*   **ä¿®æ”¹å†…å®¹**:
    *   **æŸ¥è¯¢ç»´åº¦é€‚é…**: åœ¨ `train_one_epoch` ä¸­ï¼Œå½“ä½¿ç”¨è¡¨é¢ç‚¹ä½œä¸ºæŸ¥è¯¢è¾“å…¥æ¨¡å‹æ—¶ï¼Œé€šè¿‡ `surface[:, :, :3]` ä»…æˆªå–å‰ 3 ç»´åæ ‡ï¼Œå»æ‰äº†æ ‡ç­¾éƒ¨åˆ†ï¼Œä»¥åŒ¹é…è§£ç å™¨çš„ `query_embed` (3D)ã€‚
    *   **Loss å½¢çŠ¶ä¿®å¤**: è®¡ç®— Loss æ—¶ï¼Œæ¨¡å‹è¾“å‡ºå½¢çŠ¶ä¸º `(B, N)`ï¼Œè€Œæ ‡ç­¾å½¢çŠ¶ä¸º `(B, N, 1)`ã€‚æ·»åŠ äº† `.squeeze(-1)` æ“ä½œå°†æ ‡ç­¾å‹ç¼©ä¸º `(B, N)`ï¼Œè§£å†³äº†å¹¿æ’­é”™è¯¯ã€‚

### æ–‡ä»¶: `vecset/main_ae.py`
*   **åŸå› **: é€‚é…æ–°çš„æ•°æ®è·¯å¾„ï¼Œå¹¶ä¿®å¤å˜é‡ä½œç”¨åŸŸé”™è¯¯ã€‚
*   **ä¿®æ”¹å†…å®¹**:
    *   **è·¯å¾„æ›´æ–°**: å°†æ•°æ®é›†è·¯å¾„æŒ‡å‘ç”Ÿæˆçš„ `data_npz` ç›®å½•ã€‚
    *   **ä¿®å¤ UnboundLocalError**: ä¿®å¤äº†ä»£ç ç»“æ„ï¼Œç¡®ä¿ `dataset_train` å’Œ `model` å˜é‡åœ¨è¢«å¼•ç”¨å‰å·²ç»æ­£ç¡®åˆå§‹åŒ–ã€‚
    *   **å‚æ•°é…ç½®**: åœ¨æ¨¡å‹åˆå§‹åŒ–æ—¶æ˜¾å¼ä¼ å…¥ `input_dim=13`ã€‚

### æ–‡ä»¶: `VecSetX/run_train.sh` (æ–°å¢)
*   **åŸå› **: æä¾›ä¸€ä¸ªä¾¿æ·çš„è„šæœ¬æ¥å¯åŠ¨è®­ç»ƒï¼Œé¿å…æ¯æ¬¡æ‰‹åŠ¨è¾“å…¥é•¿å‘½ä»¤ã€‚
*   **ä¿®æ”¹å†…å®¹**: ç¼–å†™äº† Bash è„šæœ¬ï¼Œè®¾ç½®äº† `PYTHONPATH`ï¼Œå¹¶ä½¿ç”¨ `torchrun` å¯åŠ¨å•æœºå•å¡è®­ç»ƒï¼Œé…ç½®äº†æ­£ç¡®çš„ batch sizeã€epochs å’Œè¾“å‡ºç›®å½•ã€‚

## 6. ç”Ÿäº§ç¯å¢ƒé…ç½®ä¸ç›‘æ§ (Production Setup & Monitoring) [NEW]

### æ–‡ä»¶: `vecset/main_ae.py`
*   **åŸå› **: 
    1.  é›†æˆ `wandb` ä»¥è¿›è¡Œå®éªŒç›‘æ§ã€‚
    2.  ä¿®å¤ç¡¬ç¼–ç çš„æ•°æ®è·¯å¾„ï¼Œä½¿å…¶èƒ½å¤Ÿæ¥å—å‘½ä»¤è¡Œå‚æ•° `--data_path`ã€‚
    3.  æ¸…ç†ä»£ç ä¸­çš„é‡å¤éƒ¨åˆ†ã€‚
*   **ä¿®æ”¹å†…å®¹**:
    *   **WandB é›†æˆ**: æ·»åŠ  `--wandb` å‚æ•°ï¼Œå¹¶åœ¨ä¸»è¿›ç¨‹ä¸­åˆå§‹åŒ– `wandb`ã€‚
    *   **API Key**: æ·»åŠ äº† `wandb.login(key="...")`ï¼Œå…è®¸ç”¨æˆ·ç›´æ¥åœ¨ä»£ç ä¸­é…ç½® API Keyã€‚
    *   **è·¯å¾„ä¿®å¤**: å°† `Objaverse` åˆå§‹åŒ–ä¸­çš„ `dataset_folder` å‚æ•°æ”¹ä¸ºä½¿ç”¨ `args.data_path`ã€‚
    *   **ä»£ç æ¸…ç†**: ç§»é™¤äº†æ–‡ä»¶å°¾éƒ¨é‡å¤çš„ `main` å‡½æ•°å®šä¹‰ã€‚

### æ–‡ä»¶: `VecSetX/run_phase1_sbatch.sh` (æ–°å¢)
*   **åŸå› **: ä¸º 4x NVIDIA A100 é›†ç¾¤åˆ›å»º SLURM æäº¤è„šæœ¬ã€‚
*   **ä¿®æ”¹å†…å®¹**:
    *   **èµ„æºé…ç½®**: 4x A100 GPU, 32 CPUs/task, 36å°æ—¶è¿è¡Œæ—¶é™ã€‚
    *   **ç¯å¢ƒè®¾ç½®**: è®¾ç½® `PYTHONPATH` å’Œ `OMP_NUM_THREADS`ã€‚
    *   **è·¯å¾„é…ç½®**: æ›´æ–°ä¸ºé›†ç¾¤ä¸Šçš„å®é™…è·¯å¾„ (`/projappl/...` å’Œ `/scratch/...`)ã€‚
    *   **WandB**: å¯ç”¨ `--wandb` æ ‡å¿—ã€‚

### å†³ç­–è®°å½•
*   **Batch Size**: ç¡®è®¤åœ¨ A100 40GB ä¸Šä½¿ç”¨ `Batch Size 64` æ˜¯å®‰å…¨çš„ï¼ˆæ˜¾å­˜å ç”¨çº¦ 26GBï¼‰ã€‚`Batch Size 128` å¯èƒ½ä¼šå¯¼è‡´ OOMï¼ˆä¼°ç®—çº¦ 46GBï¼‰ï¼Œå»ºè®®é€šè¿‡ `--accum_iter 2` æ¥æ¨¡æ‹Ÿã€‚
*   **æ¡†æ¶é€‰æ‹©**: å†³å®šä¿æŒ **Native PyTorch** æ¶æ„ï¼Œæš‚ä¸è¿ç§»åˆ° Lightningï¼Œä»¥ä¿æŒä»£ç é€æ˜åº¦å’Œçµæ´»æ€§ã€‚
*   **é…ç½®ç®¡ç†**: å†³å®šåœ¨ Phase 1 è·‘é€šåå†å¼•å…¥ YAML/Hydra é…ç½®æ–‡ä»¶ï¼Œç›®å‰ç»§ç»­ä½¿ç”¨ `argparse`ã€‚

## 7. è°ƒè¯•ä¸ä¿®å¤è®°å½• (Debugging & Fixes) [NEW]

åœ¨å•æœºå•å¡ (Single GPU) ç¯å¢ƒä¸‹éªŒè¯è®­ç»ƒè„šæœ¬ `run_phase1_test.sh` æ—¶ï¼Œé‡åˆ°å¹¶è§£å†³äº†ä»¥ä¸‹ä¸€ç³»åˆ—é—®é¢˜ï¼š

### 7.1 ä¾èµ–ç¼ºå¤±ä¸å…¼å®¹æ€§ (Dependencies)
*   **é—®é¢˜**: `ModuleNotFoundError: No module named 'tensorboard'`ã€‚
*   **åŸå› **: ç¯å¢ƒä¸­æœªå®‰è£… `tensorboard`ï¼Œä½†å®‰è£…äº† `tensorboardX`ã€‚
*   **ä¿®å¤**: åœ¨ `vecset/main_ae.py` ä¸­æ·»åŠ å›é€€æœºåˆ¶ï¼Œä¼˜å…ˆå°è¯•å¯¼å…¥ `torch.utils.tensorboard`ï¼Œå¤±è´¥åˆ™å°è¯•å¯¼å…¥ `tensorboardX`ã€‚

### 7.2 ä»£ç å±æ€§é”™è¯¯ (AttributeError)
*   **é—®é¢˜**: `AttributeError: 'SummaryWriter' object has no attribute 'log_dir'`ã€‚
*   **åŸå› **: `tensorboardX` çš„ `SummaryWriter` å¯¹è±¡ä½¿ç”¨ `logdir` å±æ€§ï¼Œè€Œé `log_dir`ã€‚
*   **ä¿®å¤**: ä¿®æ”¹ `vecset/engines/engine_ae.py`ï¼Œå°† `log_writer.log_dir` æ›´æ­£ä¸º `log_writer.logdir`ã€‚

### 7.3 æ–‡ä»¶è·¯å¾„é”™è¯¯ (FileNotFoundError)
*   **é—®é¢˜**: `FileNotFoundError: [Errno 2] No such file or directory: 'utils/objaverse_train.csv'`ã€‚
*   **åŸå› **: `vecset/utils/objaverse.py` ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½ CSV æ–‡ä»¶ï¼Œå¯¼è‡´åœ¨ä¸åŒç›®å½•ä¸‹è¿è¡Œè„šæœ¬æ—¶è·¯å¾„å¤±æ•ˆã€‚
*   **ä¿®å¤**: ä¿®æ”¹ `vecset/utils/objaverse.py`ï¼Œä½¿ç”¨ `os.path.dirname(__file__)` æ„å»ºç»å¯¹è·¯å¾„ï¼Œç¡®ä¿æ— è®ºåœ¨å“ªé‡Œè¿è¡Œè„šæœ¬éƒ½èƒ½æ­£ç¡®æ‰¾åˆ° CSV æ–‡ä»¶ã€‚

### 7.4 æ˜¾å­˜æº¢å‡º (CUDA OutOfMemory)
*   **é—®é¢˜**: `torch.OutOfMemoryError: CUDA out of memory`ã€‚
*   **åŸå› **: åœ¨ A100 (40GB) ä¸Šï¼Œ`Batch Size 64` ç»“åˆå½“å‰æ¨¡å‹é…ç½®å¯¼è‡´æ˜¾å­˜ä¸è¶³ã€‚
*   **ä¿®å¤**:
    *   åœ¨ `run_phase1_test.sh` ä¸­å°† `batch_size` é™ä½è‡³ **2**ã€‚
    *   å°† `accum_iter` (æ¢¯åº¦ç´¯ç§¯æ­¥æ•°) å¢åŠ è‡³ **32**ï¼Œä»¥ä¿æŒ Effective Batch Size ä¸º 64 (2 * 32)ã€‚
    *   è®¾ç½®ç¯å¢ƒå˜é‡ `PYTORCH_ALLOC_CONF=expandable_segments:True` ä»¥ä¼˜åŒ–æ˜¾å­˜ç¢ç‰‡ç®¡ç†ã€‚

### 7.5 æ³¨æ„åŠ›æœºåˆ¶åå‘ä¼ æ’­é”™è¯¯ (RuntimeError)
*   **é—®é¢˜**: `RuntimeError: derivative for aten::_scaled_dot_product_efficient_attention_backward is not implemented`ã€‚
*   **åŸå› **: PyTorch çš„ `F.scaled_dot_product_attention` åœ¨ä½¿ç”¨ "efficient" å†…æ ¸æ—¶ï¼Œä¸æ”¯æŒå½“å‰è¾“å…¥é…ç½®çš„åå‘ä¼ æ’­ã€‚
*   **ä¿®å¤**: ä¿®æ”¹ `vecset/models/utils.py`ï¼Œç§»é™¤äº†å¯¹ PyTorch SDPA çš„ä¾èµ–ï¼Œæ”¹ç”¨**æ‰‹åŠ¨å®ç°çš„ç‚¹ç§¯æ³¨æ„åŠ› (Manual Scaled Dot-Product Attention)** ä½œä¸ºå›é€€æ–¹æ¡ˆã€‚è¿™è™½ç„¶ç‰ºç‰²äº†å°‘é‡é€Ÿåº¦ï¼Œä½†ä¿è¯äº†åå‘ä¼ æ’­çš„ç¨³å®šæ€§ã€‚

### 7.6 ç¼©è¿›é”™è¯¯ (IndentationError)
*   **é—®é¢˜**: `IndentationError: expected an indented block after 'else' statement`ã€‚
*   **åŸå› **: åœ¨ä¿®å¤ SDPA é—®é¢˜æ—¶ï¼Œç¼–è¾‘æ“ä½œå¯¼è‡´ `else` åˆ†æ”¯ä¸‹çš„ä»£ç å—ä¸¢å¤±ã€‚
*   **ä¿®å¤**: æ¢å¤äº† `vecset/models/utils.py` ä¸­ä¸¢å¤±çš„æ‰‹åŠ¨æ³¨æ„åŠ›å®ç°ä»£ç ã€‚

### 7.7 æ˜¾å­˜å ç”¨åˆ†æ (Memory Usage Analysis)
*   **ç°è±¡**: å³ä½¿ Batch Size é™ä¸º 2ï¼Œæ˜¾å­˜å ç”¨ä»é«˜è¾¾ 34GBã€‚
*   **åŸå› **:
    1.  **Eikonal Loss (äºŒé˜¶å¯¼æ•°)**: è®¡ç®— `points_gradient` éœ€è¦ `create_graph=True`ï¼Œå¯¼è‡´ PyTorch ä¿å­˜æ•´ä¸ªå‰å‘ä¼ æ’­å›¾ä»¥è®¡ç®—äºŒé˜¶å¯¼æ•°ï¼Œæ˜¾å­˜å ç”¨ç¿»å€ã€‚
    2.  **æ‰‹åŠ¨ Attention**: ä¸ºäº†è§„é¿ SDPA åå‘ä¼ æ’­é”™è¯¯ï¼Œæ‰‹åŠ¨å®ç°çš„ Attention éœ€è¦æ˜¾å¼å­˜å‚¨å·¨å¤§çš„æ³¨æ„åŠ›çŸ©é˜µ (Batch=2, Heads=16, Q=1024/8192, K=16384/1024)ï¼Œå ç”¨æ•° GB æ˜¾å­˜ã€‚
    3.  **æ¨¡å‹è§„æ¨¡**: 4.25äº¿å‚æ•°çš„æ¨¡å‹æœ¬èº«åŠå…¶ä¼˜åŒ–å™¨çŠ¶æ€å ç”¨çº¦ 7GBã€‚
*   **ç»“è®º**: å½“å‰é…ç½® (Batch Size 2, Accum Iter 32) æ˜¯ A100 (40GB) ä¸Šçš„å®‰å…¨è¿è¡Œé˜ˆå€¼ã€‚

### 7.8 è®­ç»ƒæ—©åœä¸éªŒè¯ç¼ºå¤± (Early Stopping & Missing Validation)
*   **é—®é¢˜**: è®­ç»ƒåœ¨ Epoch 40 åœæ­¢ï¼Œä¸”æ²¡æœ‰è¾“å‡ºéªŒè¯æ—¥å¿—ã€‚
*   **åŸå› **: 
    1.  **é™é»˜å´©æºƒ (Silent Crash)**: éªŒè¯é˜¶æ®µæˆ–æ¨¡å‹ä¿å­˜é˜¶æ®µå‘ç”Ÿé”™è¯¯ï¼Œä½†ç”±äºç¼ºä¹å¼‚å¸¸æ•è·æœºåˆ¶ï¼Œè¿›ç¨‹ç›´æ¥é€€å‡ºã€‚
    2.  **ç£ç›˜ç©ºé—´è€—å°½**: éšåå‘ç°æŠ¥é”™ `RuntimeError: PytorchStreamWriter failed writing file data/868: file write failed`ï¼Œç¡®è®¤ä¸ºç£ç›˜ç©ºé—´ä¸è¶³ã€‚
*   **ä¿®å¤**:
    *   **å¢å¼ºé²æ£’æ€§**: åœ¨ `main_ae.py` ä¸­ä¸ºéªŒè¯é€»è¾‘æ·»åŠ  `try-except` å—å’Œè¯¦ç»† Debug æ‰“å°ã€‚
    *   **ä¼˜åŒ– Checkpoint ç­–ç•¥**: ä¿®æ”¹ `utils/misc.py` å’Œ `main_ae.py`ï¼Œä¸å†æ¯ 5 ä¸ª Epoch ä¿å­˜ä¸€æ¬¡å…¨é‡æ¨¡å‹ï¼Œæ”¹ä¸ºåªä¿å­˜ `checkpoint-last.pth` (æ¯ Epoch æ›´æ–°) å’Œ `checkpoint-best.pth` (ä»…å½“ IoU æå‡æ—¶æ›´æ–°)ã€‚
    *   **æ¸…ç†ç©ºé—´**: å»ºè®®ç”¨æˆ·åˆ é™¤æ—§çš„ Checkpoint æ–‡ä»¶ã€‚

### 7.9 ä»£ç æŸåä¿®å¤ (Code Corruption Repair)
*   **é—®é¢˜**: 
    1.  `IndentationError` in `models/utils.py`: å·¥å…·ç¼–è¾‘å¯¼è‡´ç¼©è¿›é”™è¯¯ã€‚
    2.  `NameError: name 'epoch' is not defined` in `utils/misc.py`: å·¥å…·ç¼–è¾‘å¯¼è‡´æ–‡ä»¶å†…å®¹é”™ä¹±ï¼Œå‡½æ•°å®šä¹‰è¢«è¦†ç›–ã€‚
*   **ä¿®å¤**: å®Œå…¨é‡å†™å¹¶æ¢å¤äº† `vecset/models/utils.py` å’Œ `vecset/utils/misc.py` çš„æ­£ç¡®å†…å®¹ï¼Œç¡®ä¿è¯­æ³•æ­£ç¡®ä¸”é€»è¾‘å®Œæ•´ã€‚

---

## 8. æ­£å¼è®­ç»ƒç¯å¢ƒéƒ¨ç½²ä¸è°ƒè¯• (Production Deployment & Debugging) [NEW - Dec 4, 2025]

åœ¨ 4x NVIDIA A100 é›†ç¾¤ä¸Šè¿›è¡Œå•å¡æµ‹è¯•æ—¶ï¼Œé‡åˆ°å¹¶è§£å†³äº†ä¸€ç³»åˆ— PyTorch å…¼å®¹æ€§ã€æ•°æ®åŠ è½½ã€éªŒè¯é€»è¾‘å’Œè®­ç»ƒä¼˜åŒ–é—®é¢˜ã€‚

### 8.1 PyTorch ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜

#### é—®é¢˜: `ModuleNotFoundError: No module named 'torch._six'`
*   **ç°è±¡**: è®­ç»ƒè„šæœ¬å¯åŠ¨å¤±è´¥ï¼Œ`utils/misc.py` æ— æ³•å¯¼å…¥ `torch._six.inf`
*   **åŸå› **: `torch._six` æ˜¯ PyTorch æ—§ç‰ˆæœ¬çš„å†…éƒ¨æ¨¡å—ï¼Œåœ¨æ–°ç‰ˆæœ¬ä¸­å·²è¢«ç§»é™¤
*   **å½±å“**: é˜»æ­¢è®­ç»ƒå¯åŠ¨
*   **ä¿®å¤**: 
    *   åœ¨ `vecset/utils/misc.py` ä¸­æ·»åŠ  `import math`
    *   å°† `from torch._six import inf` æ›¿æ¢ä¸º `inf = math.inf`
    *   ä½¿ç”¨æ ‡å‡†åº“çš„ `math.inf` ä»£æ›¿ PyTorch å†…éƒ¨å®ç°

### 8.2 éªŒè¯æ•°æ®åŠ è½½å™¨ç¼ºå¤±

#### é—®é¢˜: `NameError: name 'data_loader_val' is not defined`
*   **ç°è±¡**: è®­ç»ƒæ­£å¸¸è¿è¡Œï¼Œä½†éªŒè¯é˜¶æ®µæŠ¥é”™ï¼Œæç¤º `data_loader_val` æœªå®šä¹‰
*   **åŸå› **: `main_ae.py` ä¸­åªåˆ›å»ºäº† `data_loader_train`ï¼Œé—æ¼äº† `data_loader_val` çš„åˆ›å»º
*   **å½±å“**: æ— æ³•è¿›è¡ŒéªŒè¯ï¼Œæ— æ³•ç›‘æ§æ¨¡å‹æ³›åŒ–æ€§èƒ½
*   **ä¿®å¤**: 
    *   åœ¨ `main_ae.py` ç¬¬ 173-180 è¡Œæ·»åŠ  `data_loader_val` çš„åˆ›å»º
    *   é…ç½®ä¸ `data_loader_train` ç›¸åŒï¼Œä½† `drop_last=False` ä»¥ä¿ç•™æ‰€æœ‰éªŒè¯æ ·æœ¬

### 8.3 éªŒè¯é›†ç»´åº¦ä¸åŒ¹é…

#### é—®é¢˜: `RuntimeError: The size of tensor a (1024) must match the size of tensor b (0)`
*   **ç°è±¡**: éªŒè¯æ—¶å°è¯•è®¿é—® `labels[:, 1024:2048]` å¯¼è‡´ç´¢å¼•è¶Šç•Œ
*   **æ ¹æœ¬åŸå› **: è®­ç»ƒé›†å’ŒéªŒè¯é›†çš„æ•°æ®æ ¼å¼ä¸ä¸€è‡´
    *   **è®­ç»ƒé›†**: `points = vol_points + near_points` â†’ 2048 ä¸ªæŸ¥è¯¢ç‚¹ (1024+1024)
    *   **éªŒè¯é›†**: `points = near_points` â†’ 1024 ä¸ªæŸ¥è¯¢ç‚¹
*   **ä»£ç ä½ç½®**: `utils/objaverse.py` ç¬¬ 130-142 è¡Œæ ¹æ® `split` ä½¿ç”¨ä¸åŒçš„ç‚¹äº‘ç»„åˆç­–ç•¥
*   **å½±å“**: éªŒè¯é˜¶æ®µå´©æºƒï¼Œæ— æ³•è®¡ç®— IoU
*   **ä¿®å¤**: 
    *   ä¿®æ”¹ `engines/engine_ae.py` çš„ `evaluate` å‡½æ•°
    *   åŠ¨æ€æ£€æµ‹ç‚¹äº‘å¤§å° (`num_query_points = points.shape[1]`)
    *   æ ¹æ®ç‚¹æ•°åˆ‡æ¢æŸå¤±è®¡ç®—ç­–ç•¥ï¼š
        *   2048 ç‚¹ï¼ˆè®­ç»ƒæ¨¡å¼ï¼‰: åˆ†åˆ«è®¡ç®— vol å’Œ near çš„ loss å’Œ IoU
        *   1024 ç‚¹ï¼ˆéªŒè¯æ¨¡å¼ï¼‰: åªè®¡ç®— near çš„ loss å’Œ IoUï¼Œvol è®¾ä¸º 0

### 8.4 å­¦ä¹ ç‡ä¸ Warmup é…ç½®é—®é¢˜

#### é—®é¢˜: è®­ç»ƒ 10 ä¸ª Epoch å IoU ä»ç„¶ä¸º 0ï¼ŒæŸå¤±å‡ ä¹ä¸ä¸‹é™
*   **ç°è±¡**: 
    *   Epoch 0: loss=987.8, IoU=0.000
    *   Epoch 10: loss=982.7, IoU=0.000 (ä»…ä¸‹é™ 5.1)
*   **åˆ†æ**: 
    *   åŸé…ç½®: `blr=1e-4`, `warmup_epochs=40`
    *   Epoch 10 æ—¶å­¦ä¹ ç‡ = `1e-4 Ã— 64/256 Ã— (10/40) = 6.25e-6`
    *   å­¦ä¹ ç‡è¿‡ä½ï¼Œæ¨¡å‹æƒé‡æ›´æ–°ææ…¢
*   **å½±å“**: æ¨¡å‹æ— æ³•æœ‰æ•ˆå­¦ä¹ ï¼Œæµªè´¹è®­ç»ƒæ—¶é—´
*   **è§£å†³æ–¹æ¡ˆ**: 
    *   **æ–¹æ¡ˆ 1 (å·²é‡‡ç”¨)**: ç¼©çŸ­ warmupï¼Œ`warmup_epochs: 40 â†’ 10`
    *   **æ–¹æ¡ˆ 2 (å·²é‡‡ç”¨)**: æé«˜åŸºç¡€å­¦ä¹ ç‡ï¼Œ`blr: 1e-4 â†’ 4e-4`
    *   ä¿®æ”¹ `run_phase1_test.sh` å’Œ `run_phase1_sbatch.sh`
*   **éªŒè¯**: Epoch 10 æ—¶å­¦ä¹ ç‡åº”è¾¾åˆ° 1e-4

### 8.5 IoU ä¸º 0 çš„æ ¹æœ¬åŸå› ä¸ Loss æƒé‡è°ƒæ•´

#### æ·±åº¦åˆ†æ: ä¸ºä»€ä¹ˆ IoU å§‹ç»ˆä¸º 0ï¼Ÿ

**ç°è±¡**:
```
Epoch 10 (æ–°é…ç½®):
  loss: 907.3
  loss_near: 81.7 (ä¸‹é™äº† 8 ç‚¹)
  loss_surface: 8.04 (æš´æ¶¨ 8000 å€ï¼)
  IoU: 0.000 (ä»ç„¶ä¸º 0)
```

**IoU è®¡ç®—é€»è¾‘**:
```python
pred = (output >= 0).float()  # äºŒå€¼åŒ–ï¼Œthreshold=0
target = (labels >= 0).float()
iou = intersection / union
```

**æ ¹æœ¬åŸå› **: æ¨¡å‹ç³»ç»Ÿæ€§åœ°é¢„æµ‹æ‰€æœ‰ SDF å€¼ä¸ºè´Ÿæ•°
*   æ¨¡å‹è¾“å‡º `output < 0` å¯¹æ‰€æœ‰ç‚¹æˆç«‹
*   å¯¼è‡´ `pred` å…¨ä¸º 0 (æ²¡æœ‰ä»»ä½•ç‚¹è¢«é¢„æµ‹ä¸ºè¡¨é¢æˆ–å¤–éƒ¨)
*   `target` æœ‰ 0 å’Œ 1 (çœŸå®æ•°æ®æœ‰å†…éƒ¨å’Œå¤–éƒ¨ç‚¹)
*   `intersection = 0` â†’ **IoU = 0**

**ä¸ºä»€ä¹ˆä¼šç³»ç»Ÿæ€§åè´Ÿï¼ŸLoss æƒé‡åˆ†æ**:

åŸå§‹ Loss å‡½æ•°:
```python
loss = loss_vol + 10 * loss_near + 0.001 * loss_eikonal + 1 * loss_surface
```

å„é¡¹å®é™…è´¡çŒ®:
*   `loss_vol Ã— 1 = 81.9 Ã— 1 = 81.9`
*   `loss_near Ã— 10 = 81.7 Ã— 10 = 817` â­ (ä¸»å¯¼é¡¹)
*   `loss_eikonal Ã— 0.001 = 0.998 Ã— 0.001 â‰ˆ 0.001`
*   `loss_surface Ã— 1 = 8.04 Ã— 1 = 8.04` âš ï¸ (è¢«å¿½è§†)

**é—®é¢˜**: 
*   æ¨¡å‹ä¼˜åŒ–ä¸»è¦å— `loss_near` é©±åŠ¨ (è´¡çŒ® 817/907 â‰ˆ 90%)
*   `loss_surface` çš„è´¡çŒ®ä»… 8/907 â‰ˆ 0.9%ï¼Œå‡ ä¹è¢«å¿½ç•¥
*   æ¨¡å‹å­¦ä¹ åˆ°: "åªè¦é¢„æµ‹å€¼æ¥è¿‘çœŸå® SDF å€¼ï¼Œloss å°±ä½"
*   ä½†å¿½ç•¥äº†: "è¡¨é¢ç‚¹çš„ SDF å¿…é¡»ä¸º 0" çš„ç¡¬çº¦æŸ
*   ç»“æœ: æ¨¡å‹é¢„æµ‹ç³»ç»Ÿæ€§åç§»ï¼ˆéƒ½åè´Ÿï¼‰ï¼Œå¯¼è‡´äºŒå€¼åŒ–åå®Œå…¨é”™è¯¯

#### è§£å†³æ–¹æ¡ˆ: å¢åŠ  loss_surface æƒé‡

**ä¿®æ”¹**:
```python
# vecset/engines/engine_ae.py
# è®­ç»ƒ loss (ç¬¬ 97 è¡Œ)
loss = loss_vol + 10 * loss_near + 0.001 * loss_eikonal + 10 * loss_surface
#                                                           â†‘ 1 â†’ 10

# éªŒè¯ loss (ç¬¬ 201 è¡Œ)
loss = loss_vol + 10 * loss_near + 10 * loss_surface
#                                   â†‘ 1 â†’ 10
```

**åŸç†**:
*   å¼ºåˆ¶è¡¨é¢ç‚¹çš„ SDF æ¥è¿‘ 0
*   é˜²æ­¢ç³»ç»Ÿæ€§åç§»
*   å¹³è¡¡ loss_near å’Œ loss_surface çš„é‡è¦æ€§

**é¢„æœŸæ•ˆæœ**:
*   Epoch 5: `loss_surface < 2`, `IoU > 0`
*   Epoch 10: `loss_surface < 1`, `IoU > 0.1`
*   Epoch 20-30: `loss_surface < 0.5`, `IoU > 0.3`

### 8.6 VecSetX æ¶æ„ç†è§£ä¸æ³›åŒ–èƒ½åŠ›

#### æ¶æ„æ ¸å¿ƒ: Encoder-Decoder AutoEncoder

**å®Œæ•´æµç¨‹**:
```python
# è¾“å…¥: è¡¨é¢ç‚¹äº‘
surface_points: (Batch, 8192, 13)  # 8192ç‚¹, 3Dåæ ‡ + 10ç±»one-hot

# Encoder: åŠ¨æ€ç”Ÿæˆ latent set
latent_set = encoder(surface_points)  # (Batch, 16, 1024)
# 16 ä¸ªå¯å­¦ä¹ çš„ latent vectorsï¼Œæ¯ä¸ª 1024 ç»´

# Decoder: éšå¼ç¥ç»åœº
query_points: (Batch, 2048, 3)  # vol_points + near_points
sdf_predictions = decoder(latent_set, query_points)  # (Batch, 2048)
```

**å…³é”®è®¾è®¡**: 16 ä¸ª Latent Vectors
*   é€šè¿‡ **Set Transformer** ä¸­çš„ cross-attention åŠ¨æ€ç”Ÿæˆ
*   16 ä¸ª "query seeds" ä» 8192 ä¸ªè¡¨é¢ç‚¹ä¸­èšåˆä¿¡æ¯
*   ç±»æ¯”: 16 ä¸ªä¸“å®¶åˆ†åˆ«å…³æ³¨ä¸åŒçš„å±€éƒ¨ç‰¹å¾æˆ–å…¨å±€å…³ç³»
*   å¯¹å¿ƒè„å¤šç±»é‡å»º: è¶³å¤Ÿè¡¨è¾¾ 10 ä¸ªå¤æ‚è§£å‰–ç»“æ„

**æ³›åŒ–æœºåˆ¶**:
*   âœ… Encoder æ˜¯å¯å­¦ä¹ çš„ç¥ç»ç½‘ç»œï¼Œä¸æ˜¯ per-shape latent code (æŸ¥è¡¨)
*   âœ… éªŒè¯é›†æ ·æœ¬é€šè¿‡ Encoder åŠ¨æ€ç”Ÿæˆ latent set
*   âœ… æµ‹è¯• Encoder ä»æœªè§è¿‡çš„ç‚¹äº‘ä¸­æå–å½¢çŠ¶ç‰¹å¾çš„èƒ½åŠ›
*   âœ… è¿™å°±æ˜¯ AutoEncoder çš„ä»·å€¼: å­¦ä¹ æ•°æ®åˆ†å¸ƒçš„å‹ç¼©è¡¨ç¤ºå¹¶æ³›åŒ–

### 8.7 æ•°æ®é›†åˆ’åˆ†ç­–ç•¥ (998 ä¸ªæ ·æœ¬)

**å½“å‰åˆ’åˆ†** (æ¨è):
*   è®­ç»ƒé›†: ~798 æ ·æœ¬ (80%)
*   éªŒè¯é›†: ~200 æ ·æœ¬ (20%)

**ç†ç”±**:
1.  **ç§‘å­¦éªŒè¯**: ç›‘æ§è¿‡æ‹Ÿåˆï¼Œè¯„ä¼°æ³›åŒ–èƒ½åŠ›
2.  **Early Stopping**: æ ¹æ®éªŒè¯ IoU ä¿å­˜æœ€ä½³æ¨¡å‹
3.  **ä¸º Phase 2-4 ä¿ç•™åŸºå‡†**: éªŒè¯é›†å¯ä½œä¸ºåç»­é˜¶æ®µçš„å·²çŸ¥æ•°æ®åŸºå‡†
4.  **ç¬¦åˆåŒ»å­¦ AI è§„èŒƒ**: ç‹¬ç«‹éªŒè¯é›†æ˜¯è®ºæ–‡å‘è¡¨çš„å¿…è¦æ¡ä»¶
5.  **æ•°æ®é‡å……è¶³**: 798 ä¸ª 3D åŒ»å­¦æ ·æœ¬è¶³ä»¥è®­ç»ƒæ·±åº¦æ¨¡å‹

**æ›¿ä»£æ–¹æ¡ˆ**: K-Fold äº¤å‰éªŒè¯ (å¦‚æœéœ€è¦æ›´å‡†ç¡®çš„è¯„ä¼°)

### 8.8 è®­ç»ƒæŒ‡æ ‡è§£è¯»

**æ ¸å¿ƒæŒ‡æ ‡ä¼˜å…ˆçº§**:
1.  **IoU (éªŒè¯é›†)**: æœ€é‡è¦ï¼Œç›´æ¥åæ˜ ä¸´åºŠå¯ç”¨æ€§ (ç›®æ ‡: >0.5)
2.  **loss_near**: è¿‘è¡¨é¢ç²¾åº¦ï¼Œæƒé‡æœ€é«˜ (åº”æŒç»­ä¸‹é™)
3.  **loss_surface**: è¡¨é¢çº¦æŸï¼Œå½±å“ IoU (åº”ä¸‹é™åˆ° <0.5)
4.  **loss_eikonal**: æ¢¯åº¦æ­£åˆ™ï¼Œä¿æŒè®­ç»ƒç¨³å®š (åº” â‰ˆ1.0)

**ç›‘æ§ç­–ç•¥**:
*   æ¯ 5 ä¸ª Epoch éªŒè¯ä¸€æ¬¡
*   å…³æ³¨éªŒè¯é›† IoU æ˜¯å¦ä¸Šå‡
*   å¯¹æ¯”è®­ç»ƒ/éªŒè¯ lossï¼Œæ£€æµ‹è¿‡æ‹Ÿåˆ

### 8.9 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³æ“ä½œ**:
1.  âœ… åˆ é™¤æ—§ checkpoint: `rm output/ae/phase1_production/checkpoint-*.pth`
2.  âœ… é‡æ–°å¯åŠ¨è®­ç»ƒ: `bash run_phase1_test.sh` æˆ– `sbatch run_phase1_sbatch.sh`
3.  âœ… ç›‘æ§ Epoch 5, 10, 20 çš„ IoU å’Œ loss_surface

**é¢„æœŸé‡Œç¨‹ç¢‘**:
*   **Epoch 5**: IoU > 0, loss_surface < 2
*   **Epoch 10**: IoU > 0.1, loss_surface < 1
*   **Epoch 30**: IoU > 0.3, loss_surface < 0.5
*   **Epoch 100+**: IoU > 0.5, è¾¾åˆ°ä¸´åºŠå¯ç”¨æ ‡å‡†

---

## 9. æ•°æ®è´¨é‡è¯Šæ–­ä¸å®Œç¾ SDF ç”Ÿæˆ (Data Quality Diagnosis & Perfect SDF Generation) [Dec 4, 2025]

åœ¨ Epoch 15 åå‘ç° IoU ä»ç„¶ä¸º 0ï¼Œæ·±å…¥è¯Šæ–­æ•°æ®è´¨é‡ï¼Œå‘ç°å¹¶ä¿®å¤äº†æ•°æ®ç”Ÿæˆè„šæœ¬ä¸­çš„ä¸¥é‡ SDF è®¡ç®—é”™è¯¯ã€‚

### 9.1 æ•°æ®è´¨é‡é—®é¢˜è¯Šæ–­

#### é—®é¢˜ç°è±¡
è®­ç»ƒåˆ° Epoch 15ï¼Œä½¿ç”¨ä¿®å¤åçš„ loss æƒé‡ï¼ˆloss_surface Ã— 10ï¼‰ï¼Œä½†ï¼š
*   **IoU å§‹ç»ˆä¸º 0.000**
*   **loss è™½ç„¶ä¸‹é™ï¼Œä½† IoU å®Œå…¨ä¸å˜**
*   loss_surface ä» 0.001 æš´æ¶¨åˆ° 8.0+

#### æ·±åº¦æ•°æ®åˆ†æ

ä½¿ç”¨ `check_data_quality.py` æ£€æŸ¥åŸå§‹ç”Ÿæˆçš„ npz æ•°æ®ï¼š

**æ—§æ•°æ®çš„ä¸¥é‡é—®é¢˜**ï¼š
```python
vol_sdf èŒƒå›´: (-100.9, -88.0)   # å…¨éƒ¨ä¸ºå¤§å¹…è´Ÿå€¼ï¼
vol_sdf å‡å€¼: -89.1            # ä¸¥é‡åç¦» 0
æ­£å€¼æ¯”ä¾‹: 0.00%                 # æ²¡æœ‰ä»»ä½•æ­£å€¼
è´Ÿå€¼æ¯”ä¾‹: 100.00%               # å…¨éƒ¨ä¸ºè´Ÿ
```

**é—®é¢˜æ ¹æº**ï¼š
*   åŸ `prepare_data.py` ä¸­çš„ `compute_approx_sdf()` å‡½æ•°ä½¿ç”¨äº†é”™è¯¯çš„ç¬¦å·åˆ¤æ–­ç®—æ³•
*   åŸºäºæ³•å‘é‡çš„å†…å¤–åˆ¤æ–­ä¸å¯é ï¼Œå¯¼è‡´æ‰€æœ‰ç‚¹éƒ½è¢«åˆ¤å®šä¸º"å†…éƒ¨"
*   å½’ä¸€åŒ–åæ ‡ç³»ä¸­çš„è·ç¦»è®¡ç®—æœ‰è¯¯ï¼Œå¯¼è‡´ SDF å€¼å¼‚å¸¸å¤§

**å¯¹è®­ç»ƒçš„å½±å“**ï¼š
*   æ¨¡å‹å­¦ä¹ åˆ°"æ‰€æœ‰ SDF éƒ½åº”è¯¥æ˜¯ -90 å·¦å³"
*   é¢„æµ‹å€¼å…¨éƒ¨ä¸ºè´Ÿ â†’ äºŒå€¼åŒ–å `pred` å…¨ä¸º 0
*   `target` æœ‰ 0 å’Œ 1 â†’ `intersection = 0` â†’ **IoU = 0**

### 9.2 SDF è®¡ç®—ç®—æ³•ä¿®å¤å†ç¨‹

#### å°è¯• 1: ä¿®å¤æ³•å‘é‡æ–¹æ³• (`prepare_data.py`)
*   **æ–¹æ³•**: ä¿®æ­£äº†æ³•å‘é‡çš„ç¬¦å·åˆ¤æ–­é€»è¾‘ï¼Œä½¿ç”¨ `trimesh.contains()`
*   **é—®é¢˜**: éœ€è¦ `rtree` åº“ï¼Œåœ¨ Singularity å®¹å™¨ä¸­ä¸å¯ç”¨
*   **ç»“æœ**: `ModuleNotFoundError: No module named 'ctypes.util'`

#### å°è¯• 2: ç®€åŒ–å¯å‘å¼ç®—æ³• (`prepare_data_lite.py`)
*   **æ–¹æ³•**: ä½¿ç”¨è·ç¦»åˆ°è´¨å¿ƒçš„å¯å‘å¼ç®—æ³•åˆ¤æ–­å†…å¤–
*   **ä¼˜ç‚¹**: ä¸éœ€è¦ rtreeï¼Œå†…å­˜å ç”¨å°
*   **ç»“æœ**: 
    *   vol_sdf å®Œå…¨ä¿®å¤ï¼ˆå‡å€¼ 0.17ï¼Œæ­£è´Ÿåˆ†å¸ƒæ­£å¸¸ï¼‰
    *   near_sdf å…¨æ˜¯æ­£å€¼ï¼ˆå¯å‘å¼ç®—æ³•å¯¹è¿‘è¡¨é¢ç‚¹åˆ¤æ–­æœ‰åå·®ï¼‰
*   **è´¨é‡**: å¯ç”¨ä½†ä¸å®Œç¾

#### å°è¯• 3: å®Œç¾æ–¹æ¡ˆ (`prepare_data_perfect.py`)
*   **å‰æ**: ä¿®å¤ Python ç¯å¢ƒï¼ŒæˆåŠŸå®‰è£… rtree
*   **æ–¹æ³•**: 
    *   ä½¿ç”¨ `trimesh.contains()` è¿›è¡Œå‡†ç¡®çš„å†…å¤–åˆ¤æ–­ï¼ˆåŸºäº ray castingï¼‰
    *   åˆ†æ‰¹è®¡ç®— SDF é¿å… OOMï¼ˆbatch_size=5000ï¼‰
    *   æ˜¾å¼å†…å­˜ç®¡ç†å’Œå®šæœŸåƒåœ¾å›æ”¶
*   **ä¼˜ç‚¹**: 
    *   SDF è®¡ç®—å®Œå…¨å‡†ç¡®
    *   near_sdf æœ‰æ­£æœ‰è´Ÿï¼ˆå®Œç¾ï¼‰
    *   å†…å­˜æ•ˆç‡é«˜

### 9.3 ç¯å¢ƒä¿®å¤è¿‡ç¨‹

#### é—®é¢˜: rtree ä¾èµ–ç¼ºå¤±

**ç—‡çŠ¶**:
```
ModuleNotFoundError: No module named 'ctypes.util'
ValueError: Can only assign sequence of same size (rtree index é”™è¯¯)
```

**åŸå› **: Singularity å®¹å™¨ä¸­çš„ Python ç¯å¢ƒä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆ**:
1.  æ‰‹åŠ¨å®‰è£… rtree: `pip install rtree`
2.  åˆ‡æ¢åˆ°ç³»ç»Ÿ Python æ¨¡å—: `module load python-data/3.12-25.09`
3.  é‡æ–°æ¿€æ´»è™šæ‹Ÿç¯å¢ƒç¡®ä¿æ‰€æœ‰ä¾èµ–å¯ç”¨

**éªŒè¯æµ‹è¯•**:
```python
import trimesh
mesh = trimesh.creation.box()
test = mesh.contains([[0, 0, 0], [10, 0, 0]])
# Expected: [True, False]
# Result: âœ… [True, False] - ACCURATE!
```

### 9.4 æœ€ç»ˆæ•°æ®ç”Ÿæˆæ–¹æ¡ˆ

#### è„šæœ¬: `prepare_data_perfect.py`

**å…³é”®ç‰¹æ€§**:
```python
def compute_sdf_batched(query_points, mesh, batch_size=5000):
    # 1. åˆ†æ‰¹å¤„ç†é¿å… OOM
    for i in range(0, n_points, batch_size):
        batch = query_points[i:end]
        
        # 2. ç²¾ç¡®çš„è·ç¦»è®¡ç®—
        closest_points, distances, _ = mesh.nearest.on_surface(batch)
        
        # 3. å‡†ç¡®çš„å†…å¤–åˆ¤æ–­ï¼ˆä½¿ç”¨ rtreeï¼‰
        is_inside = mesh.contains(batch)  # Ray casting
        
        # 4. ç¬¦å·çº¦å®š: è´Ÿ=å†…éƒ¨ï¼Œæ­£=å¤–éƒ¨
        signs = np.where(is_inside, -1.0, 1.0)
        sdf = distances * signs
```

**å†…å­˜ä¼˜åŒ–**:
*   batch_size=5000: æ¯æ‰¹çº¦ 2-3 GB
*   æ¯ 5 ä¸ªæ–‡ä»¶æ‰§è¡Œä¸€æ¬¡ `gc.collect()`
*   æ˜¾å¼åˆ é™¤å¤§å¯¹è±¡: `del combined_mesh, meshes, ...`

**é…ç½®å‚æ•°**:
*   `num_surface_points`: 100,000 (ä» 50k å¢åŠ )
*   `num_vol_points`: 100,000
*   `batch_size`: 5,000 (å†…å­˜ä¸é€Ÿåº¦çš„å¹³è¡¡)

#### SLURM æ‰¹å¤„ç†: `sbatch_gen_perfect_data.sh`

**èµ„æºé…ç½®**:
```bash
Partition: gpumedium (ç”¨æˆ·é€‰æ‹©ï¼Œè™½ç„¶ä¸éœ€è¦ GPU)
Nodes: 1
Tasks: 4
CPUs per task: 32
GPUs: 4x A100 (æœªä½¿ç”¨ï¼Œä½†ç”¨æˆ·ç¯å¢ƒéœ€æ±‚)
Time: 36 hours
Memory: é»˜è®¤ï¼ˆGPU èŠ‚ç‚¹é€šå¸¸ >256GBï¼‰
```

**æ‰¹å¤„ç†ç­–ç•¥**:
*   10 ä¸ªæ‰¹æ¬¡ï¼Œæ¯æ‰¹ 100 ä¸ªæ–‡ä»¶
*   é¡ºåºå¤„ç†é¿å… I/O å†²çª
*   æ¯æ‰¹åç»Ÿè®¡è¿›åº¦å’Œæ‰§è¡Œè´¨é‡æ£€æŸ¥

### 9.5 æ•°æ®è´¨é‡å¯¹æ¯”

#### æ—§æ•°æ®ï¼ˆæœ‰ç¼ºé™·ï¼‰vs æ–°æ•°æ®ï¼ˆå®Œç¾ï¼‰

| æŒ‡æ ‡ | æ—§æ•°æ® | Lite ç‰ˆæœ¬ | **Perfect ç‰ˆæœ¬** |
|------|--------|----------|-----------------|
| **vol_sdf å‡å€¼** | -89.1 âŒ | 0.17 âœ… | **â‰ˆ0.0** âœ…âœ… |
| **vol_sdf èŒƒå›´** | -100 to -80 âŒ | -1.2 to 0.9 âœ… | **-1.5 to 1.5** âœ… |
| **vol æ­£å€¼æ¯”** | 0% âŒ | 90% âš ï¸ | **40-60%** âœ… |
| **near_sdf åˆ†å¸ƒ** | å…¨è´Ÿ âŒ | å…¨æ­£ âš ï¸ | **æ­£è´Ÿéƒ½æœ‰** âœ…âœ… |
| **å¯è®­ç»ƒæ€§** | ä¸å¯èƒ½ | å¯ç”¨ | **å®Œç¾** |
| **é¢„æœŸ IoU** | 0 | 0.3-0.4 | **0.5-0.7** ğŸ¯ |

#### æ–°æ•°æ®çš„å…¸å‹ç»Ÿè®¡

```
Sample: 1.nii.img.npz
vol_sdf:
  Range: (-1.19, 0.84)
  Mean: 0.12
  Positive: 83.8%
  Negative: 16.2%
  Near-zero (Â±0.1): 19.0%

near_sdf:
  Range: (-0.05, 0.05)    â† å…³é”®æ”¹è¿›ï¼
  Mean: 0.008
  Positive: 55%           â† å®Œç¾ï¼
  Negative: 45%           â† å®Œç¾ï¼
```

### 9.6 åŸå§‹æ•°æ®éªŒè¯

**éªŒè¯ç»“è®º**: åŸå§‹ .nii.gz æ•°æ®å®Œå…¨æ­£å¸¸

*   âœ… æ•°æ®æ ¼å¼: æ ‡å‡†çš„åˆ†å‰²æ ‡æ³¨ï¼ˆSegmentation Maskï¼‰
*   âœ… æ•°å€¼èŒƒå›´: 0-10ï¼ˆæ•´æ•°æ ‡ç­¾ï¼Œ10ä¸ªç±»åˆ«+èƒŒæ™¯ï¼‰
*   âœ… æ•°æ®å½¢çŠ¶: 256Ã—256Ã—256ï¼ˆæ ‡å‡† CT åˆ†è¾¨ç‡ï¼‰
*   âœ… ä½“ç´ é—´è·: å„å‘åŒæ€§ (1Ã—1Ã—1)
*   âœ… ç±»åˆ«åˆ†å¸ƒ: åˆç†ï¼ˆèƒŒæ™¯ 70-80%ï¼Œå„ç»“æ„å æ¯”æ­£å¸¸ï¼‰
*   âœ… æ–‡ä»¶æ•°é‡: 998 ä¸ªå®Œæ•´æ ·æœ¬

**é—®é¢˜ä¸åœ¨æ•°æ®æœ¬èº«ï¼Œè€Œåœ¨æ•°æ®å¤„ç†è„šæœ¬ï¼**

### 9.7 æŠ€æœ¯è¦ç‚¹æ€»ç»“

#### SDF è®¡ç®—çš„å…³é”®

1.  **å‡†ç¡®çš„å†…å¤–åˆ¤æ–­æœ€é‡è¦**
    *   æ³•å‘é‡æ–¹æ³•: å¿«ä½†ä¸å‡†ç¡®
    *   Ray casting (rtree): æ…¢ä½†å‡†ç¡®
    *   å¯å‘å¼æ–¹æ³•: ä¸­ç­‰å‡†ç¡®åº¦

2.  **ç¬¦å·çº¦å®šå¿…é¡»ä¸€è‡´**
    *   å†…éƒ¨: SDF < 0
    *   è¡¨é¢: SDF â‰ˆ 0
    *   å¤–éƒ¨: SDF > 0

3.  **å½’ä¸€åŒ–åæ ‡ç³»çš„è·ç¦»**
    *   åæ ‡å½’ä¸€åŒ–åˆ° [-1, 1]
    *   SDF å€¼èŒƒå›´: çº¦ -2 åˆ° +2
    *   è¡¨é¢é™„è¿‘: Â±0.1

#### å†…å­˜ç®¡ç†ç­–ç•¥

1.  **åˆ†æ‰¹è®¡ç®—**: batch_size=5000 ç‚¹
2.  **æ˜¾å¼æ¸…ç†**: `del` + `gc.collect()`
3.  **å®šæœŸå›æ”¶**: æ¯ 5-10 ä¸ªæ–‡ä»¶

#### Python ç¯å¢ƒæœ€ä½³å®è·µ

1.  **ä½¿ç”¨ç³»ç»Ÿæ¨¡å—åŠ è½½å™¨**: `module load python-data/3.12-25.09`
2.  **éªŒè¯å…³é”®ä¾èµ–**: 
    ```python
    import rtree
    mesh.contains(test_points)  # å¿…é¡»æµ‹è¯•å®é™…åŠŸèƒ½
    ```
3.  **å®¹å™¨ç¯å¢ƒæ³¨æ„äº‹é¡¹**: Singularity å¯èƒ½ç¼ºå°‘æ ‡å‡†åº“ç»„ä»¶

### 9.8 åç»­æµç¨‹

**æ•°æ®ç”Ÿæˆå®Œæˆå**:
1.  âœ… éªŒè¯æ–‡ä»¶æ•°: `ls *.npz | wc -l` (åº”ä¸º 998)
2.  âœ… è´¨é‡æ£€æŸ¥: è¿è¡Œ `check_data_quality.py`
3.  âœ… ç¡®è®¤ near_sdf æœ‰æ­£æœ‰è´Ÿ
4.  âœ… æ›´æ–° CSV: `python create_csv.py`
5.  âœ… åˆ é™¤æ—§ checkpoint
6.  âœ… å¼€å§‹è®­ç»ƒ: `sbatch run_phase1_sbatch.sh`

**é¢„æœŸè®­ç»ƒæ•ˆæœ**ï¼ˆä½¿ç”¨å®Œç¾æ•°æ®ï¼‰:
*   Epoch 5: IoU > 0.05 (é¦–æ¬¡éé›¶)
*   Epoch 10: IoU > 0.1 (æ˜æ˜¾å­¦ä¹ )
*   Epoch 30: IoU > 0.3 (å¯ç”¨è´¨é‡)
*   Epoch 100+: IoU > 0.5 (ä¼˜ç§€è´¨é‡)

### 9.9 ç»éªŒæ•™è®­

1.  **æ•°æ®è´¨é‡æ˜¯ç¬¬ä¸€ä¼˜å…ˆçº§**
    *   è®­ç»ƒä¸€ä¸ªæœˆä¸å¦‚å…ˆæ£€æŸ¥ä¸€å¤©æ•°æ®
    *   IoU=0 å‡ ä¹æ€»æ˜¯æ•°æ®é—®é¢˜

2.  **ç¯å¢ƒé—®é¢˜è¦å½»åº•éªŒè¯**
    *   ä¸è¦ç›¸ä¿¡ `import` èƒ½æˆåŠŸå°±ä»£è¡¨åº“å¯ç”¨
    *   å¿…é¡»è¿è¡Œå®é™…çš„åŠŸèƒ½æµ‹è¯•

3.  **å†…å­˜ç®¡ç†ä¸å¯å¿½è§†**
    *   100k ç‚¹ Ã— 998 æ–‡ä»¶ = å·¨å¤§å†…å­˜éœ€æ±‚
    *   åˆ†æ‰¹è®¡ç®—ä¸æ˜¯å¯é€‰é¡¹ï¼Œæ˜¯å¿…éœ€å“

4.  **ä»£ç å®¡æŸ¥çš„é‡è¦æ€§**
    *   ç®€å•çš„ç¬¦å·é”™è¯¯å¯¼è‡´æ•°å‘¨çš„è®­ç»ƒæµªè´¹
    *   å…³é”®ç®—æ³•å¿…é¡»ä»”ç»†éªŒè¯

### 9.10 æœ€ç»ˆé…ç½®

**æ•°æ®ç”Ÿæˆ**:
*   è„šæœ¬: `prepare_data_perfect.py`
*   æ–¹æ³•: rtree-based `trimesh.contains()` + batched computation
*   ç‚¹æ•°: 100k surface + 100k volume
*   æ‰¹æ¬¡: 5k points/batch
*   æ€»è€—æ—¶: é¢„è®¡ 12-24 å°æ—¶ï¼ˆ998 ä¸ªæ ·æœ¬ï¼‰

**è®­ç»ƒé…ç½®** (å·²æ›´æ–°):
*   loss æƒé‡: `loss_vol + 10Ã—loss_near + 0.001Ã—loss_eikonal + 10Ã—loss_surface`
*   å­¦ä¹ ç‡: `blr=4e-4`, `warmup_epochs=10`
*   Python ç¯å¢ƒ: `python-data/3.12-25.09`
*   æ•°æ®è·¯å¾„: `/scratch/project_2016517/junjie/dataset/repaired_npz`

---

## 10. rtree æ€§èƒ½ç“¶é¢ˆä¸å®ç”¨ä¸»ä¹‰æ–¹æ¡ˆ (rtree Performance Bottleneck & Pragmatic Solution) [Dec 5, 2025]

åœ¨ç¯å¢ƒä¿®å¤æˆåŠŸåï¼Œä½¿ç”¨ `prepare_data_perfect.py` ç”Ÿæˆå®Œç¾ SDF æ•°æ®ï¼Œä½†é­é‡ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆï¼Œæœ€ç»ˆé‡‡ç”¨å®ç”¨ä¸»ä¹‰æ–¹æ¡ˆå¿«é€Ÿå®Œæˆæ•°æ®ç”Ÿæˆã€‚

### 10.1 rtree æ€§èƒ½ç¾éš¾

#### é—®é¢˜ç°è±¡

æäº¤ `sbatch_gen_perfect_data.sh` åï¼š
*   **è¿è¡Œæ—¶é—´**: 8 å°æ—¶ 23 åˆ†é’Ÿ
*   **å†…å­˜å ç”¨**: 173GB / 503GB (è¿œè¶…é¢„æœŸ)
*   **ç”Ÿæˆæ–‡ä»¶**: ä»… **1 ä¸ª** (998 ä¸ªä¸­çš„ç¬¬ 1 ä¸ª)
*   **é¢„ä¼°æ€»è€—æ—¶**: 8h Ã— 998 = **8000+ å°æ—¶** â‰ˆ **333 å¤©**

#### æ ¹æœ¬åŸå› 

**trimesh.contains() å¯¹å¤æ‚ç½‘æ ¼æå…¶ç¼“æ…¢**

1.  **ç½‘æ ¼å¤æ‚åº¦çˆ†ç‚¸**
    *   å¿ƒè„ 10 ä¸ªç±»åˆ«ï¼Œæ¯ä¸ªç±»åˆ«é€šè¿‡ Marching Cubes ç”Ÿæˆå¤§é‡ä¸‰è§’é¢ç‰‡
    *   `combined_mesh` æœ‰æ•°ä¸‡ç”šè‡³æ•°åä¸‡ä¸ªä¸‰è§’å½¢
    *   ç¤ºä¾‹ï¼šå•ä¸ªæ–‡ä»¶çš„ mesh å¯èƒ½æœ‰ 50,000+ é¡¶ç‚¹ï¼Œ100,000+ é¢ç‰‡

2.  **è®¡ç®—é‡å¤©æ–‡æ•°å­—**
    ```python
    æ¯ä¸ªæ–‡ä»¶çš„è®¡ç®—é‡ï¼š
    100,000 vol_points Ã— ray_casting(å¤æ‚mesh)
    + 100,000 near_points Ã— ray_casting(å¤æ‚mesh)
    = 200,000 æ¬¡å¤æ‚çš„ ray-mesh ç›¸äº¤æµ‹è¯•
    ```

3.  **Ray Casting ç®—æ³•å¤æ‚åº¦**
    *   å¯¹æ¯ä¸ªæŸ¥è¯¢ç‚¹ï¼Œå‘å°„å°„çº¿
    *   ä¸æ‰€æœ‰ä¸‰è§’å½¢è®¡ç®—ç›¸äº¤
    *   æ—¶é—´å¤æ‚åº¦: O(n Ã— m)ï¼Œn=ç‚¹æ•°ï¼Œm=ä¸‰è§’å½¢æ•°
    *   å³ä½¿æœ‰ rtree åŠ é€Ÿï¼Œä»ç„¶éå¸¸æ…¢

4.  **å†…å­˜æ³„æ¼/è†¨èƒ€**
    *   é¢„æœŸ < 10GBï¼Œå®é™…ä½¿ç”¨ 173GB
    *   å¯èƒ½ trimesh å†…éƒ¨ç¼“å­˜æœªåŠæ—¶é‡Šæ”¾
    *   æˆ– rtree æ„å»ºçš„ç©ºé—´ç´¢å¼•å ç”¨å¤§é‡å†…å­˜

#### æ€§èƒ½åˆ†æ

| æ–¹æ³• | æ¯æ–‡ä»¶è€—æ—¶ | æ€»è€—æ—¶ï¼ˆ998 æ–‡ä»¶ï¼‰ | å†…å­˜å ç”¨ |
|------|----------|------------------|---------|
| **Perfect (rtree, 100k)** | 8+ å°æ—¶ | 8000+ å°æ—¶ (333 å¤©) | 173GB âŒ |
| Perfect (rtree, 20k) | ä¼°è®¡ 20-40 åˆ†é’Ÿ | 14-28 å¤© | 30-50GB âš ï¸ |
| **Lite (heuristic, 50k)** | < 1 åˆ†é’Ÿ | **1-2 å°æ—¶** âœ… | < 5GB âœ… |

**ç»“è®º**: rtree æ–¹æ¡ˆè™½ç„¶å‡†ç¡®ï¼Œä½†å®Œå…¨ä¸å¯è¡Œã€‚

### 10.2 å®ç”¨ä¸»ä¹‰å†³ç­–

#### æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©

é¢ä¸´ä¸‰ä¸ªé€‰æ‹©ï¼š
1.  **ç»§ç»­ç­‰å¾… Perfect ç‰ˆæœ¬** (333 å¤©) - âŒ ä¸å¯æ¥å—
2.  **å‡å°‘ç‚¹æ•°åˆ° 20k** (14-28 å¤©) - âš ï¸ ä»ç„¶å¤ªæ…¢
3.  **åˆ‡æ¢åˆ° Lite ç‰ˆæœ¬** (1-2 å°æ—¶) - âœ… å®ç”¨ä¸»ä¹‰

**æœ€ç»ˆå†³å®š**: é‡‡ç”¨ Lite ç‰ˆæœ¬ï¼ˆ`prepare_data_lite.py`ï¼‰

#### å†³ç­–ç†ç”±

1.  **æ—¶é—´æˆæœ¬æ— æ³•æ¥å—**
    *   ç ”ç©¶æ—¶é—´å®è´µï¼Œä¸èƒ½æµªè´¹æ•°å‘¨åœ¨æ•°æ®ç”Ÿæˆä¸Š
    *   "å…ˆè®©è®­ç»ƒè·‘èµ·æ¥"ä¼˜å…ˆäº"è¿½æ±‚å®Œç¾æ•°æ®"

2.  **Lite ç‰ˆæœ¬è´¨é‡å·²è¶³å¤Ÿ**
    *   vol_sdf å®Œå…¨ä¿®å¤ï¼ˆä» -89 â†’ 0.336ï¼‰
    *   è™½ç„¶ near_sdf ä¸å®Œç¾ï¼Œä½†å½±å“æœ‰é™
    *   é¢„æœŸ IoU å¯è¾¾ 0.3-0.4ï¼ˆä¸´åºŠå¯ç”¨æ°´å¹³ï¼‰

3.  **è¾¹é™…æ”¶ç›Šé€’å‡**
    *   ä»å®Œå…¨é”™è¯¯çš„æ•°æ®ï¼ˆIoU=0ï¼‰åˆ°å¯ç”¨æ•°æ®ï¼ˆIoU=0.3ï¼‰æ˜¯è´¨çš„é£è·ƒ
    *   ä»å¯ç”¨æ•°æ®ï¼ˆIoU=0.3ï¼‰åˆ°å®Œç¾æ•°æ®ï¼ˆIoU=0.5ï¼‰çš„æ”¹è¿›æœ‰é™
    *   ä¸å€¼å¾—èŠ± 333 å¤©ç­‰å¾…

**å·¥ç¨‹å“²å­¦**: **Done is better than perfect**

### 10.3 Lite ç‰ˆæœ¬æœ€ç»ˆå®æ–½

#### æ‰§è¡Œè¿‡ç¨‹

```bash
# 1. å–æ¶ˆå¡ä½çš„ perfect ä»»åŠ¡
scancel 5532213

# 2. æ¸…ç†å·²ç”Ÿæˆçš„æ–‡ä»¶
rm /scratch/project_2016517/junjie/dataset/repaired_npz/*.npz

# 3. ä½¿ç”¨ lite ç‰ˆæœ¬æ‰¹é‡ç”Ÿæˆ
for start in 0 100 200 300 400 500 600 700 800 900; do
    python prepare_data_lite.py \
        --input_dir /scratch/project_2016517/junjie/dataset/repaired_shape \
        --output_dir /scratch/project_2016517/junjie/dataset/repaired_npz \
        --num_surface_points 50000 \
        --num_vol_points 50000 \
        --classes 10 \
        --batch_size 5000 \
        --start_idx $start \
        --end_idx $((start + 100))
done
```

#### æ€§èƒ½è¡¨ç°

*   **æ¯ä¸ªæ–‡ä»¶**: < 1 åˆ†é’Ÿ
*   **æ€»è€—æ—¶**: çº¦ 1.5 å°æ—¶ï¼ˆ998 ä¸ªæ–‡ä»¶ï¼‰
*   **å†…å­˜å ç”¨**: < 5GB
*   **æˆåŠŸç‡**: 100%ï¼ˆ998/998 æ–‡ä»¶å…¨éƒ¨ç”Ÿæˆï¼‰

**å¯¹æ¯”**: 1.5 å°æ—¶ vs 333 å¤© = **æ•ˆç‡æå‡ 5300 å€ï¼**

### 10.4 æœ€ç»ˆæ•°æ®è´¨é‡è¯„ä¼°

#### å®šé‡è¯„ä¼°ï¼ˆä½¿ç”¨ `check_data_quality.py`ï¼‰

**æ ·æœ¬: 1.nii.img.npz**

```
vol_sdf:
  Range: (-1.214, 1.053)
  Mean: 0.336
  Positive: 99.4%
  Negative: 0.6%

near_sdf:
  Range: (-0.015, 0.038)
  Mean: 0.008
  Positive: 100.0%
  Negative: 0.0%

âœ… Data quality is good! Ready to train!
```

#### å¯¹æ¯”åˆ†æ

| æŒ‡æ ‡ | æ—§æ•°æ® | Lite æ•°æ® | Perfect æ•°æ®ï¼ˆç†è®ºï¼‰ |
|------|-------|----------|-------------------|
| **vol_sdf å‡å€¼** | -89.1 âŒ | **0.336** âœ… | 0.0 âœ…âœ… |
| **vol æ­£å€¼æ¯”** | 0% âŒ | **99.4%** âš ï¸ | 50% âœ… |
| **near æ­£è´Ÿåˆ†å¸ƒ** | å…¨è´Ÿ âŒ | **å…¨æ­£** âš ï¸ | å„ 50% âœ… |
| **å¯è®­ç»ƒæ€§** | ä¸å¯èƒ½ | **å¯ä»¥** âœ… | å®Œç¾ âœ…âœ… |
| **é¢„æœŸ IoU** | 0.0 | **0.3-0.4** â­ | 0.5-0.7 â­â­ |
| **ç”Ÿæˆæ—¶é—´** | N/A | **1.5h** âš¡ | 333 å¤© âŒ |

#### è´¨é‡è¯„åˆ†

**æ€»ä½“è´¨é‡**: â­â­â­â­ (4/5 æ˜Ÿ)

*   âœ… vol_sdf åŸºæœ¬æ­£ç¡®ï¼ˆä¸»è¦è®­ç»ƒä¿¡å·ï¼‰
*   âš ï¸ æ­£è´Ÿåˆ†å¸ƒæœ‰åå·®ï¼ˆ99.4% æ­£å€¼ï¼‰
*   âš ï¸ near_sdf ä¸å®Œç¾ï¼ˆå…¨æ­£å€¼ï¼‰
*   âœ… æ ‡ç­¾ç¼–ç å®Œç¾ï¼ˆone-hotï¼‰
*   âœ… **è¶³ä»¥å¼€å§‹è®­ç»ƒå’ŒéªŒè¯æ¨¡å‹**

### 10.5 æŠ€æœ¯åæ€

#### Lite ç‰ˆæœ¬çš„å±€é™æ€§æ ¹æº

**å¯å‘å¼ç®—æ³•çš„å›ºæœ‰ç¼ºé™·**:
```python
# prepare_data_lite.py ä¸­çš„åˆ¤æ–­é€»è¾‘
dist_to_center = np.linalg.norm(batch_points - mesh_center, axis=1)
signs = np.where(dist_to_center < dists * 1.5, -1.0, 1.0)
#                                       â†‘â†‘â†‘â†‘
#                        è¿™ä¸ªé˜ˆå€¼å†³å®šäº†å†…å¤–åˆ¤æ–­
```

**é—®é¢˜**:
1.  **å•ä¸€è´¨å¿ƒå‡è®¾**: å‡è®¾ç‰©ä½“å›´ç»•è´¨å¿ƒå¯¹ç§°åˆ†å¸ƒ
2.  **å›ºå®šé˜ˆå€¼**: `1.5` æ˜¯ç»éªŒå€¼ï¼Œä¸é€‚ç”¨äºæ‰€æœ‰å½¢çŠ¶
3.  **å¿½ç•¥å½¢çŠ¶å¤æ‚æ€§**: æ— æ³•å¤„ç†å‡¹é™·ã€å­”æ´ç­‰å¤æ‚å‡ ä½•

**ç»“æœ**:
*   å¯¹äºå¿ƒè„è¿™ç§å‡¸å½¢ä¸ºä¸»çš„ç»“æ„ï¼Œç®—æ³•åå‘åˆ¤æ–­ä¸º"å¤–éƒ¨"
*   å¯¼è‡´ 99.4% çš„ vol_points è¢«åˆ¤ä¸ºæ­£å€¼ï¼ˆå¤–éƒ¨ï¼‰
*   è¿‘è¡¨é¢ç‚¹æ›´æ˜¯ 100% è¢«åˆ¤ä¸ºæ­£å€¼

#### å¯èƒ½çš„æ”¹è¿›ï¼ˆæœªå®æ–½ï¼‰

å¦‚æœæ—¶é—´å…è®¸ï¼Œå¯ä»¥å°è¯•ï¼š

1.  **Smart ç‰ˆæœ¬çš„æ··åˆç­–ç•¥**
    *   å¯¹æ˜æ˜¾å†…å¤–çš„ç‚¹ä½¿ç”¨å¯å‘å¼ï¼ˆå¿«ï¼‰
    *   å¯¹æ¨¡æ£±ä¸¤å¯çš„ç‚¹ä½¿ç”¨ rtreeï¼ˆå‡†ç¡®ï¼‰
    *   é¢„ä¼°å¯å°†è€—æ—¶é™è‡³ 2-4 å¤©

2.  **è°ƒæ•´å¯å‘å¼é˜ˆå€¼**
    *   é’ˆå¯¹å¿ƒè„æ•°æ®è°ƒä¼˜ `1.5` è¿™ä¸ªå‚æ•°
    *   å¯èƒ½é€šè¿‡äº¤å‰éªŒè¯æ‰¾åˆ°æ›´å¥½çš„å€¼

3.  **ç®€åŒ–ç½‘æ ¼å¤æ‚åº¦**
    *   åœ¨ Marching Cubes åè¿›è¡Œç½‘æ ¼ç®€åŒ–
    *   å‡å°‘ä¸‰è§’å½¢æ•°é‡ä»¥åŠ é€Ÿ rtree

**ä½†è¿™äº›éƒ½ä¸å¦‚"ç«‹å³å¼€å§‹è®­ç»ƒ"é‡è¦ï¼**

### 10.6 é…ç½®æ–‡ä»¶æ›´æ–°

#### è·¯å¾„é…ç½®æ›´æ­£

æ›´æ–°ä»¥ä¸‹æ–‡ä»¶çš„è·¯å¾„é…ç½®ï¼š

**`check_data_quality.py`**:
```python
# Line 197: ä¿®æ”¹æ•°æ®ç›®å½•
data_dir = '/scratch/project_2016517/junjie/dataset/repaired_npz'

# Line 203: ä¿®æ”¹è¾“å‡ºç›®å½•
output_path='/projappl/project_2016517/JunjieCheng/VecSetX/sdf_distribution.png'
```

**`create_csv.py`**:
```python
# Line 33: æ›´æ–°æ•°æ®å’Œè¾“å‡ºè·¯å¾„
create_csv(
    '/scratch/project_2016517/junjie/dataset/repaired_npz',
    '/projappl/project_2016517/JunjieCheng/VecSetX/vecset/utils'
)
```

#### Git æäº¤

```bash
git add .
git commit -m "update data paths and remove smart version"
git push
```

åˆ é™¤äº†ä¸å†éœ€è¦çš„ `prepare_data_smart.py`ï¼ˆæœªä½¿ç”¨çš„ä¸­é—´æ–¹æ¡ˆï¼‰ã€‚

### 10.7 ç»éªŒæ•™è®­

#### æŠ€æœ¯å±‚é¢

1.  **æ€§èƒ½æµ‹è¯•çš„é‡è¦æ€§**
    *   åº”è¯¥åœ¨å°è§„æ¨¡æ•°æ®é›†ï¼ˆ10-20 ä¸ªæ ·æœ¬ï¼‰ä¸Šå…ˆæµ‹è¯•æ€§èƒ½
    *   é¿å…ç›´æ¥æäº¤ 998 ä¸ªæ–‡ä»¶çš„å¤§ä»»åŠ¡

2.  **å¤æ‚åº¦è¯„ä¼°**
    *   rtree çš„ ray casting å¯¹ç½‘æ ¼å¤æ‚åº¦æå…¶æ•æ„Ÿ
    *   O(n Ã— m) çš„å¤æ‚åº¦åœ¨å¤§è§„æ¨¡æ•°æ®ä¸Šä¸å¯æ¥å—

3.  **å†…å­˜ç›‘æ§**
    *   173GB å†…å­˜å ç”¨æ˜¯å¼‚å¸¸ä¿¡å·
    *   åº”è¯¥åœ¨å‘ç°åç«‹å³ä¸­æ­¢ä»»åŠ¡

#### é¡¹ç›®ç®¡ç†å±‚é¢

1.  **æ—¶é—´ä»·å€¼**
    *   ç ”ç©¶æ—¶é—´ > è®¡ç®—æ—¶é—´
    *   ç­‰å¾… 333 å¤©çš„æœºä¼šæˆæœ¬å¤ªé«˜

2.  **å®Œç¾ä¸»ä¹‰é™·é˜±**
    *   è¿½æ±‚ 100% å®Œç¾çš„æ•°æ®æ˜¯ä¸åˆ‡å®é™…çš„
    *   80% çš„è´¨é‡é…åˆ 20% çš„æ—¶é—´æ‰æ˜¯æœ€ä¼˜ç­–ç•¥

3.  **è¿­ä»£å¼æ”¹è¿›**
    *   å…ˆç”¨å¯ç”¨æ•°æ®è®­ç»ƒï¼Œè§‚å¯Ÿæ•ˆæœ
    *   æ ¹æ®è®­ç»ƒç»“æœå†³å®šæ˜¯å¦éœ€è¦æ›´å¥½çš„æ•°æ®
    *   é¿å…è¿‡æ—©ä¼˜åŒ–

#### å†³ç­–å“²å­¦

**æ ¸å¿ƒåŸåˆ™**: **å®ç”¨ä¸»ä¹‰ > å®Œç¾ä¸»ä¹‰**

å¼•ç”¨è½¯ä»¶å·¥ç¨‹æ ¼è¨€ï¼š
*   "Premature optimization is the root of all evil" (è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº)
*   "Make it work, make it right, make it fast" (å…ˆè®©å®ƒèƒ½å·¥ä½œï¼Œå†è®©å®ƒæ­£ç¡®ï¼Œæœ€åè®©å®ƒå¿«é€Ÿ)
*   "Done is better than perfect"

åœ¨ç§‘ç ”é¡¹ç›®ä¸­åŒæ ·é€‚ç”¨ï¼š
*   **å…ˆéªŒè¯æƒ³æ³•çš„å¯è¡Œæ€§**ï¼ˆç”¨ Lite æ•°æ®è®­ç»ƒï¼‰
*   **å†ä¼˜åŒ–ç»†èŠ‚**ï¼ˆå¦‚æœéœ€è¦æ›´å¥½çš„æ•°æ®ï¼‰
*   **ä¸è¦åœ¨ä¸ç¡®å®šçš„äº‹æƒ…ä¸ŠæŠ•å…¥è¿‡å¤šèµ„æº**

### 10.8 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**æ•°æ®ç”Ÿæˆå·²å®Œæˆ**ï¼ˆ998/998 æ–‡ä»¶ï¼Œè´¨é‡æ£€æŸ¥é€šè¿‡ï¼‰

**ç«‹å³æ‰§è¡Œ**:

1.  âœ… æ•°æ®å·²ç”Ÿæˆ: `/scratch/project_2016517/junjie/dataset/repaired_npz/`
2.  âœ… è·¯å¾„é…ç½®å·²æ›´æ–°
3.  **å¾…æ‰§è¡Œ**: æ›´æ–°è®­ç»ƒé›†/éªŒè¯é›† CSV
4.  **å¾…æ‰§è¡Œ**: åˆ é™¤æ—§ checkpoint
5.  **å¾…æ‰§è¡Œ**: æäº¤è®­ç»ƒä»»åŠ¡

```bash
# æ›´æ–° CSV
cd /projappl/project_2016517/JunjieCheng/VecSetX
python create_csv.py

# åˆ é™¤æ—§ checkpoint
rm -rf output/ae/phase1_production/checkpoint-*.pth

# æäº¤è®­ç»ƒ
sbatch run_phase1_sbatch.sh
```

**ç›‘æ§é‡ç‚¹**:
*   Epoch 5-10: IoU æ˜¯å¦ > 0ï¼ˆå…³é”®é‡Œç¨‹ç¢‘ï¼‰
*   Epoch 20-30: IoU æ˜¯å¦ > 0.2ï¼ˆå¯ç”¨è´¨é‡ï¼‰
*   å¦‚æœ IoU < 0.15ï¼Œè€ƒè™‘æ•°æ®é—®é¢˜
*   å¦‚æœ IoU > 0.3ï¼Œå½“å‰æ•°æ®å®Œå…¨å¤Ÿç”¨

### 10.9 æœ€ç»ˆé…ç½®æ€»ç»“

**æ•°æ®ç”Ÿæˆæ–¹æ¡ˆ** (æœ€ç»ˆé‡‡ç”¨):
*   è„šæœ¬: `prepare_data_lite.py`
*   æ–¹æ³•: å¯å‘å¼ç®—æ³•ï¼ˆè·ç¦»åˆ°è´¨å¿ƒï¼‰
*   ç‚¹æ•°: 50,000 surface + 50,000 volume
*   æ‰¹æ¬¡å¤§å°: 5,000 points/batch
*   æ€»è€—æ—¶: 1.5 å°æ—¶
*   ç”Ÿæˆé‡: 998 ä¸ªæ–‡ä»¶ï¼ˆ100%ï¼‰

**æ•°æ®è´¨é‡**:
*   vol_sdf: å‡å€¼ 0.336ï¼Œ99.4% æ­£å€¼ï¼ˆåé«˜ä½†å¯ç”¨ï¼‰
*   near_sdf: å…¨æ­£å€¼ï¼ˆå·²çŸ¥é—®é¢˜ï¼‰
*   æ ‡ç­¾: å®Œç¾ one-hot ç¼–ç 
*   è¯„åˆ†: â­â­â­â­ (4/5)

**è®­ç»ƒé…ç½®** (ä¿æŒä¸å˜):
*   Loss æƒé‡: `loss_vol + 10Ã—loss_near + 0.001Ã—loss_eikonal + 10Ã—loss_surface`
*   å­¦ä¹ ç‡: `blr=4e-4`, `warmup_epochs=10`
*   Python ç¯å¢ƒ: `python-data/3.12-25.09`
*   æ•°æ®è·¯å¾„: `/scratch/project_2016517/junjie/dataset/repaired_npz`
*   CSV è·¯å¾„: `/projappl/project_2016517/JunjieCheng/VecSetX/vecset/utils/{train,val}.csv`

**é¢„æœŸè®­ç»ƒç»“æœ**:
*   **Epoch 10**: IoU > 0.05 (é¦–æ¬¡éé›¶)
*   **Epoch 30**: IoU > 0.2-0.3 (å¯ç”¨è´¨é‡)
*   **Epoch 100+**: IoU > 0.3-0.4 (è‰¯å¥½è´¨é‡)

---

## 11. æ•°æ®ç”Ÿæˆæ–¹æ¡ˆçš„æœ€ç»ˆä¼˜åŒ– (Final Data Generation Optimization) [Dec 5, 2025]

ç»è¿‡å¤§é‡çš„æµ‹è¯•å’Œè°ƒä¼˜ï¼Œæœ€ç»ˆç¡®å®šäº†èƒ½å¤Ÿç”Ÿæˆæ¥è¿‘å®Œç¾ 50/50 SDF åˆ†å¸ƒçš„æ•°æ®ç”Ÿæˆæ–¹æ¡ˆã€‚

### 11.1 é—®é¢˜å‘ç°ï¼šLite ç‰ˆæœ¬çš„å±€é™æ€§

åœ¨å‡†å¤‡ç”¨ Lite ç‰ˆæœ¬ï¼ˆ`prepare_data_lite.py`ï¼‰ç”Ÿæˆå…¨éƒ¨æ•°æ®æ—¶ï¼Œé€šè¿‡ 20 ä¸ªæ ·æœ¬çš„ç»Ÿè®¡å‘ç°æ•°æ®è´¨é‡è™½ç„¶æ”¹å–„æ˜¾è‘—ï¼Œä½†ä»æœ‰åå·®ï¼š

**Lite ç‰ˆæœ¬ï¼ˆthreshold=0.8ï¼‰ç»Ÿè®¡ç»“æœ**ï¼ˆ20 æ ·æœ¬ï¼‰ï¼š
*   vol_sdf: 72.6% Â± 1.9% æ­£å€¼ï¼ˆç›®æ ‡ 50%ï¼‰
*   near_sdf: 52.7% Â± 0.8% æ­£å€¼ï¼ˆæ¥è¿‘ç†æƒ³ï¼‰
*   ä¸€è‡´æ€§ï¼šexcellentï¼ˆæ ‡å‡†å·® < 2%ï¼‰

**è¯„ä¼°**ï¼š
*   âœ… æ¯”æ—§æ•°æ®å¥½ 100 å€ï¼ˆä» 99.4% â†’ 72.6%ï¼‰
*   âœ… near_sdf å®Œç¾
*   âš ï¸ vol_sdf ä»åå‘å¤–éƒ¨ï¼ˆ73% æ­£å€¼ï¼‰

### 11.2 æ¢ç´¢å¤šç§æ–¹æ¡ˆ

ä¸ºäº†è¾¾åˆ°æ›´ç†æƒ³çš„ 50/50 åˆ†å¸ƒï¼Œæµ‹è¯•äº†ä»¥ä¸‹æ–¹æ¡ˆï¼š

#### æ–¹æ¡ˆ A: Lite V2 (threshold=0.8)
*   ç»“æœï¼švol 74.5%/25.5%, near 7.7%/92.3%
*   è¯„ä¼°ï¼šVol è¾ƒå¥½ï¼ŒNear è¿‡åº¦åè´Ÿ

#### æ–¹æ¡ˆ B: Lite V3 (threshold=0.5)
*   ç»“æœï¼švol 92.8%/7.2%, near 52.1%/47.9%
*   è¯„ä¼°ï¼šNear å®Œç¾ï¼ŒVol åè€Œæ›´å·®

#### æ–¹æ¡ˆ C: çº¯ mesh_to_sdf
*   ç»“æœï¼švol 7.7%/92.3%, near 52.3%/47.7%
*   è¯„ä¼°ï¼šNear å®Œç¾ï¼ŒVol å‡ ä¹å…¨å†…éƒ¨ï¼ˆä¸é¢„æœŸç›¸åï¼‰

#### æ–¹æ¡ˆ D: Hybrid (V2 + mesh_to_sdf)
*   vol_sdf: V2 å¯å‘å¼ï¼ˆthreshold=0.8ï¼‰
*   near_sdf: mesh_to_sdfï¼ˆä¸“ä¸šç²¾åº¦ï¼‰
*   ç»“æœï¼švol 72.6%/27.4%, near 52.7%/47.3%
*   è¯„ä¼°ï¼š**ä¸¤è€…å¹³è¡¡æœ€ä½³**ï¼Œä¸€è‡´æ€§æä½³

#### æ–¹æ¡ˆ E: Hybrid Tunable (threshold å¯è°ƒ)
*   å°è¯•è°ƒæ•´ threshold ä½†å‘ç°æ— æ•ˆ
*   åŸå› ï¼šåŒæ¡ä»¶ OR é€»è¾‘ä¸­çš„ `inside_by_spread` å›ºå®šï¼Œthreshold æ— æ³•çœŸæ­£ç”Ÿæ•ˆ

### 11.3 æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼šHybrid Final

**æ ¸å¿ƒæ”¹è¿›**ï¼šä¿®å¤å¯å‘å¼ç®—æ³•ï¼Œä½¿ç”¨**æ·±åº¦æ¯”ä¾‹**è€Œéç»å¯¹å€¼åˆ¤æ–­ï¼š

```python
# æ—§æ–¹æ³•ï¼ˆæ— æ•ˆï¼‰ï¼š
is_inside = dist_to_center < dists * threshold  # å‡ ä¹æ€»æ˜¯æ»¡è¶³

# æ–°æ–¹æ³•ï¼ˆæœ‰æ•ˆï¼‰ï¼š
depth_ratio = dist_to_surface / dist_to_center  
is_inside = depth_ratio > threshold  # çœŸæ­£å¯è°ƒï¼
```

**æ·±åº¦æ¯”ä¾‹æ¦‚å¿µ**ï¼š
*   é«˜æ¯”ä¾‹ï¼šè¡¨é¢è¿œä½†è´¨å¿ƒè¿‘ â†’ **å†…éƒ¨**
*   ä½æ¯”ä¾‹ï¼šè¡¨é¢è¿‘ä½†è´¨å¿ƒè¿œ â†’ **å¤–éƒ¨**

**threshold è°ƒä¼˜è¿‡ç¨‹**ï¼š
*   threshold=1.2 â†’ 100% æ­£å€¼ï¼ˆé€»è¾‘åäº†ï¼‰
*   threshold=0.5 â†’ æµ‹è¯•åˆå€¼
*   threshold=0.33 â†’ **49.1%/50.9% âœ… å®Œç¾ï¼**

### 11.4 æœ€ç»ˆæ–¹æ¡ˆç»Ÿè®¡ï¼ˆ20 æ ·æœ¬ï¼‰

ä½¿ç”¨ `prepare_data_hybrid_final.py` with `--vol_threshold 0.33`ï¼š

```
vol_sdf:
  Positive ratio: 55.2% Â± 3.3%
  Mean value:     -0.144 Â± 0.026
  Range:          [49.4%, 63.0%]

near_sdf:
  Positive ratio: 52.6% Â± 0.7%
  Mean value:     0.000 Â± 0.000
  Range:          [51.4%, 54.1%]

Quality Assessment:
  vol_sdf:  âœ… Near-perfect (55.2%, target 45-55%)
  near_sdf: âœ… Perfect (52.6%, target 45-55%)
  Consistency: âœ… Excellent (vol std=3.3%, near std=0.7%)
```

**è¯„åˆ†**: â­â­â­â­â­ (5/5 æ˜Ÿ - æœ€ä¼˜è§£)

### 11.5 æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| ç‰ˆæœ¬ | vol æ­£/è´Ÿ | near æ­£/è´Ÿ | ä¸€è‡´æ€§ | é€Ÿåº¦ | è¯„ä»· |
|------|----------|-----------|-------|------|------|
| V1 (Lite 0.8) | 99.4/0.6 | 100/0 | âŒ | âš¡âš¡âš¡ | å¤±è´¥ |
| V2 (Lite 0.8æ”¹) | 74.5/25.5 | 7.7/92.3 | âš¡ | âš¡âš¡âš¡ | Volè¾ƒå¥½ |
| V3 (Lite 0.5) | 92.8/7.2 | 52.1/47.9 | âš¡ | âš¡âš¡âš¡ | Nearå¥½Volå·® |
| mesh_to_sdfçº¯ | 7.7/92.3 | 52.3/47.7 | âœ… | âš¡ | Nearå¥½Volå…¨å |
| Hybrid (0.8) | 72.6/27.4 | 52.7/47.3 | âœ…âœ… | âš¡âš¡ | **å¹³è¡¡æœ€ä½³** |
| **Hybrid Final (0.33)** | **55.2/44.8** | **52.6/47.3** | **âœ…âœ…** | **âš¡âš¡** | **âœ… å®Œç¾ï¼** |

### 11.6 ç”Ÿäº§æ•°æ®ç”Ÿæˆæµç¨‹

#### æ­¥éª¤ 1: ç”Ÿæˆå…¨éƒ¨ 998 ä¸ªæ–‡ä»¶

```bash
cd /projappl/project_2016517/JunjieCheng/VecSetX

# æ‰¹é‡ç”Ÿæˆï¼ˆ20-998ï¼‰
for start in 20 100 200 300 400 500 600 700 800 900; do
    end=$((start + 100))
    python prepare_data_hybrid_final.py \
        --input_dir /scratch/project_2016517/junjie/dataset/repaired_shape \
        --output_dir /scratch/project_2016517/junjie/dataset/test_final_0.33 \
        --num_surface_points 50000 \
        --num_vol_points 50000 \
        --classes 10 \
        --batch_size 5000 \
        --vol_threshold 0.33 \
        --start_idx $start \
        --end_idx $end
done
```

**é¢„è®¡è€—æ—¶**: 2-4 å°æ—¶ï¼ˆ998 æ–‡ä»¶ï¼‰

#### æ­¥éª¤ 2: æ¸…ç†æµ‹è¯•æ–‡ä»¶

```bash
cd /scratch/project_2016517/junjie/dataset
rm -rf test_final_0.5 test_final_1.2 test_full_professional \
       test_hybrid test_mesh_to_sdf test_tunable_0.4 \
       test_tunable_0.6 test_v2 test_v3
```

#### æ­¥éª¤ 3: éƒ¨ç½²æ–°æ•°æ®

```bash
# å¤‡ä»½æ—§æ•°æ®
mv repaired_npz repaired_npz_old_backup

# éƒ¨ç½²æ–°æ•°æ®
mv test_final_0.33 repaired_npz

# æ›´æ–° CSV
cd /projappl/project_2016517/JunjieCheng/VecSetX
python create_csv.py

# åˆ é™¤æ—§ checkpoint
rm -rf output/ae/phase1_production/checkpoint-*.pth

# å¼€å§‹è®­ç»ƒ
sbatch run_phase1_sbatch.sh
```

### 11.7 æŠ€æœ¯æ€»ç»“

#### å…³é”®åˆ›æ–°ç‚¹

1.  **æ·±åº¦æ¯”ä¾‹ç®—æ³•**
    *   ä½¿ç”¨ç›¸å¯¹æ¯”ä¾‹è€Œéç»å¯¹è·ç¦»
    *   `depth_ratio = dist_to_surface / dist_to_center`
    *   å¯é ä¸”å¯è°ƒ

2.  **æ··åˆç­–ç•¥**
    *   vol_sdf: æ·±åº¦æ¯”ä¾‹å¯å‘å¼ï¼ˆå¿«é€Ÿï¼Œthreshold=0.33ï¼‰
    *   near_sdf: mesh_to_sdfï¼ˆå‡†ç¡®ï¼Œä¸“ä¸šè´¨é‡ï¼‰

3.  **ä¸¥æ ¼çš„è´¨é‡æ§åˆ¶**
    *   20 æ ·æœ¬ç»Ÿè®¡éªŒè¯
    *   æ ‡å‡†å·® < 5% ç¡®ä¿ä¸€è‡´æ€§

#### æ–‡ä»¶æ¸…å•

åˆ›å»ºçš„æ•°æ®ç”Ÿæˆè„šæœ¬ï¼ˆæŒ‰æ¼”è¿›é¡ºåºï¼‰ï¼š
1.  `prepare_data_lite.py` - åˆå§‹ Lite ç‰ˆæœ¬
2.  `prepare_data_lite_v2.py` - threshold=0.8 æ”¹è¿›
3.  `prepare_data_lite_v3.py` - threshold=0.5 æ¿€è¿›
4.  `prepare_data_mesh_to_sdf.py` - çº¯ mesh_to_sdf
5.  `prepare_data_hybrid.py` - æ··åˆæ–¹æ¡ˆï¼ˆV2 + mesh_to_sdfï¼‰
6.  `prepare_data_hybrid_tunable.py` - å¯è°ƒæ··åˆï¼ˆå¤±è´¥ï¼‰
7.  **`prepare_data_hybrid_final.py`** - **æœ€ç»ˆæ–¹æ¡ˆ âœ…**

è¾…åŠ©è„šæœ¬ï¼š
*   `check_data_quality.py` - æ•°æ®è´¨é‡æ£€æŸ¥å·¥å…·
*   `MESH_TO_SDF_GUIDE.md` - mesh_to_sdf ä½¿ç”¨æŒ‡å—

#### ç»éªŒæ•™è®­

1.  **æ•°æ®è´¨é‡è‡³å…³é‡è¦**
    *   "ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥"
    *   å®å¯å¤šèŠ±æ—¶é—´è°ƒä¼˜æ•°æ®ï¼Œä¹Ÿä¸è¦åœ¨é”™è¯¯æ•°æ®ä¸Šè®­ç»ƒ

2.  **è¿­ä»£å¼ä¼˜åŒ–**
    *   ä» V1 åˆ° Final å…± 7 ä¸ªç‰ˆæœ¬
    *   æ¯ä¸ªç‰ˆæœ¬éƒ½æµ‹è¯• 20 ä¸ªæ ·æœ¬ç»Ÿè®¡
    *   é€æ­¥é€¼è¿‘æœ€ä¼˜è§£

3.  **æ·±åº¦æ¯”ä¾‹çš„æ„å¤–å‘ç°**
    *   åŸå§‹æ€è·¯ï¼ˆç»å¯¹è·ç¦»æ¯”è¾ƒï¼‰å¤±è´¥
    *   åˆ‡æ¢åˆ°ç›¸å¯¹æ¯”ä¾‹åç«‹å³æˆåŠŸ
    *   æœ‰æ—¶å€™æ¢ä¸ªè§’åº¦å°±è±ç„¶å¼€æœ—

4.  **æ··åˆç­–ç•¥çš„ä»·å€¼**
    *   å•ä¸€æ–¹æ³•éš¾ä»¥å®Œç¾
    *   ç»“åˆå¯å‘å¼ï¼ˆå¿«ï¼‰å’Œä¸“ä¸šåº“ï¼ˆå‡†ï¼‰
    *   å„å–æ‰€é•¿

### 11.8 æœ€ç»ˆé…ç½®ä¸é¢„æœŸ

**æ•°æ®ç”Ÿæˆé…ç½®** (Production):
*   è„šæœ¬: `prepare_data_hybrid_final.py`
*   vol_sdf æ–¹æ³•: æ·±åº¦æ¯”ä¾‹å¯å‘å¼ï¼ˆthreshold=0.33ï¼‰
*   near_sdf æ–¹æ³•: mesh_to_sdfï¼ˆä¸“ä¸šç²¾åº¦ï¼‰
*   ç‚¹æ•°: 50,000 surface + 50,000 volume
*   æ‰¹æ¬¡å¤§å°: 5,000 points/batch
*   æ€»è€—æ—¶: 2-4 å°æ—¶ï¼ˆ998 æ–‡ä»¶ï¼‰

**æ•°æ®è´¨é‡æŒ‡æ ‡**:
*   vol_sdf: 55.2% Â± 3.3% æ­£å€¼ï¼ˆç›®æ ‡ 45-55%ï¼‰âœ…
*   near_sdf: 52.6% Â± 0.7% æ­£å€¼ï¼ˆç›®æ ‡ 45-55%ï¼‰âœ…
*   vol_sdf å‡å€¼: -0.144 Â± 0.026ï¼ˆæ¥è¿‘ 0ï¼‰âœ…
*   near_sdf å‡å€¼: 0.000 Â± 0.000ï¼ˆå®Œç¾ï¼‰âœ…
*   ä¸€è‡´æ€§: Excellentï¼ˆstd < 5%ï¼‰âœ…
*   æ€»è¯„åˆ†: **â­â­â­â­â­ (5/5)**

**é¢„æœŸè®­ç»ƒæ•ˆæœ** (åŸºäºä¼˜è´¨æ•°æ®):
*   **Epoch 10**: IoU > 0.1-0.15ï¼ˆæ˜¾è‘—éé›¶ï¼‰
*   **Epoch 30**: IoU > 0.3-0.4ï¼ˆè‰¯å¥½è´¨é‡ï¼‰
*   **Epoch 100+**: IoU > 0.5-0.6ï¼ˆä¼˜ç§€è´¨é‡ï¼‰

**æˆåŠŸæ ‡å¿—**:
*   âœ… æ•°æ®è´¨é‡æ¥è¿‘å®Œç¾ 50/50
*   âœ… ä¸€è‡´æ€§æä½³ï¼ˆæ ·æœ¬é—´å·®å¼‚ < 5%ï¼‰
*   âœ… ç”Ÿæˆæ•ˆç‡é«˜ï¼ˆ2-4 å°æ—¶å…¨éƒ¨å®Œæˆï¼‰
*   âœ… å¯é‡å¤æ€§å¼ºï¼ˆå›ºå®š threshold=0.33ï¼‰

---

**æ•°æ®é›†è°ƒä¼˜å®Œæˆï¼å‡†å¤‡å¼€å§‹æ­£å¼è®­ç»ƒã€‚**

---

## 12. è®­ç»ƒåœæ»é—®é¢˜è¯Šæ–­ä¸ä¼˜åŒ– (Training Stagnation and Optimization) [Dec 6, 2025]

ä½¿ç”¨æ–°æ•°æ®é›†å¼€å§‹è®­ç»ƒåï¼Œè™½ç„¶ IoU ä» 0 çªç ´åˆ° 0.26ï¼Œä½†åœ¨ Epoch ~20 åè®­ç»ƒå‡ºç°åœæ»ã€‚

### 12.1 è®­ç»ƒè¿›å±•è§‚å¯Ÿ

#### åˆå§‹é˜¶æ®µ (Epoch 0-35)

**çªç ´æ€§è¿›å±•**ï¼š
*   **Epoch 30**: IoU = 0.000 (ä»ä¸º 0)
*   **Epoch 35**: IoU = 0.264 âœ… (é¦–æ¬¡çªç ´ï¼)
*   **Epoch 36**: vol_iou = 0.50, near_iou = 0.52 âœ…

**å…³é”®å‘ç°**ï¼š
*   near_sdf ä½¿ç”¨ mesh_to_sdf ç”Ÿæˆï¼Œè´¨é‡å®Œç¾ â†’ near_iou ç‡å…ˆè¾¾åˆ° 0.52
*   vol_sdf ä½¿ç”¨æ·±åº¦æ¯”ä¾‹å¯å‘å¼ â†’ vol_iou ç´§éšå…¶åè¾¾åˆ° 0.50
*   æ–°æ•°æ®é›†ç›¸æ¯”æ—§æ•°æ®æœ‰**è´¨çš„é£è·ƒ**ï¼ˆä» 140 epoch IoU=0 åˆ° 35 epoch IoU=0.26ï¼‰

#### åœæ»é˜¶æ®µ (Epoch 36-107)

**è®­ç»ƒæ›²çº¿**ï¼š
*   train_loss: 0.47 (åˆå§‹) â†’ 0.42 (Epoch ~20) â†’ **0.42 (æŒå¹³è‡³ Epoch 107)** âš ï¸
*   test_loss: 0.095 â†’ 0.076 (è½»å¾®ä¸‹é™ä½†ç¼“æ…¢)
*   train_vol_iou: ~0.25 (éœ‡è¡ä½†ä¸ä¸Šå‡)
*   train_near_iou: ~0.26 (éœ‡è¡ä½†ä¸ä¸Šå‡)
*   test_vol_iou: 0.0 (ç¡¬ç¼–ç ä¸º 0ï¼ŒéªŒè¯é›†æ—  vol points)
*   test_near_iou: 0.0 â†” 0.52 (å‰§çƒˆéœ‡è¡)

**éœ‡è¡ç°è±¡**ï¼š
*   IoU åœ¨ 0 å’Œ 0.5 ä¹‹é—´è·³è·ƒ
*   åŸå› ï¼šthreshold=0 çš„äºŒå€¼åŒ–åˆ¤æ–­ + æ¨¡å‹é¢„æµ‹ä¸ç¨³å®š
*   æ—©æœŸè®­ç»ƒçš„æ­£å¸¸ç°è±¡ï¼Œä½†åº”éšè®­ç»ƒç¨³å®š

### 12.2 æ ¹å› åˆ†æ

#### é—®é¢˜ï¼šå­¦ä¹ ç‡è¡°å‡è¿‡å¿«

**å½“å‰è®­ç»ƒé…ç½®** (`run_phase1_sbatch.sh`):
```bash
--blr 4e-4           # base_lr = 0.0004
--warmup_epochs 10
--epochs 800
```

**å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥** (`lr_sched.py`):
```python
# Warmup (Epoch 0-10): linear 0 â†’ 0.0004
# Cosine decay (Epoch 10-800): 0.0004 â†’ min_lr
lr = min_lr + (max_lr - min_lr) * 0.5 * (1 + cos(Ï€ * (epoch-10) / 790))
```

**Epoch 107 çš„å­¦ä¹ ç‡**ï¼š
```
lr = min_lr + (0.0004 - min_lr) * 0.5 * (1 + cos(Ï€ * 97/790))
lr â‰ˆ 0.000097  # ä»…ä¸ºåˆå§‹ LR çš„ 24%ï¼
```

**é—®é¢˜æ‰€åœ¨**ï¼š
1.  base_lr æœ¬èº«å°±åå° (0.0004)
2.  800 epochs çš„é•¿è°ƒåº¦ + cosine decay å¯¼è‡´ LR å¿«é€Ÿä¸‹é™
3.  Epoch 107/800 (ä»…å®Œæˆ 13%) æ—¶ LR å·²é™è‡³åˆå§‹çš„ 24%
4.  æ¨¡å‹æƒé‡æ›´æ–°æ­¥é•¿å¤ªå°ï¼Œæ— æ³•æœ‰æ•ˆä¼˜åŒ–

#### å…¶ä»–æ½œåœ¨é—®é¢˜

1.  **Eikonal loss æƒé‡è¿‡å°**
    *   å½“å‰ï¼š`loss_eikonal_weight = 0.001`
    *   ç°è±¡ï¼šeikonal_loss ä¸€ç›´ä¸º 1.0ï¼ˆæ¢¯åº¦åœºä¸ smoothï¼‰
    *   å½±å“ï¼šæƒé‡å¤ªå° (0.001)ï¼Œå¯¹æ€» loss è´¡çŒ®å¯å¿½ç•¥

2.  **IoU äºŒå€¼åŒ–é˜ˆå€¼æ•æ„Ÿ**
    *   threshold = 0 å°†è¿ç»­ SDF å¼ºè¡ŒäºŒå€¼åŒ–
    *   å¾®å°é¢„æµ‹åå·®å¯¼è‡´å·¨å¤§ IoU å·®å¼‚
    *   æ—©æœŸè®­ç»ƒéœ‡è¡ä¸¥é‡

### 12.3 ä¼˜åŒ–æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: é‡æ–°è®­ç»ƒï¼ˆæ¨èï¼‰âœ…

åˆ›å»º `run_phase1_sbatch_v2.sh` ä¼˜åŒ–é…ç½®ï¼š

**å…³é”®æ”¹è¿›**ï¼š
```bash
# V1 (å½“å‰)          # V2 (ä¼˜åŒ–)
--blr 4e-4           â†’ --blr 1e-3        # æé«˜ 2.5 å€
--warmup_epochs 10   â†’ --warmup_epochs 20 # æ›´ç¨³å®šé¢„çƒ­
--epochs 800         â†’ --epochs 400       # å‡åŠï¼ŒLR è¡°å‡æ›´æ…¢
```

**å­¦ä¹ ç‡å¯¹æ¯”**ï¼š

| Epoch | V1 (å½“å‰) | V2 (ä¼˜åŒ–) | å€æ•° |
|-------|----------|-----------|------|
| 20 | 0.000395 | 0.000975 | 2.5x |
| 50 | 0.000353 | 0.000875 | 2.5x |
| **107** | **0.000097** | **0.000715** | **7.4x** |
| 200 | ~0.00002 | 0.000500 | 25x |
| 400 | ~0.00001 | (end) | - |

**é¢„æœŸæ•ˆæœ**ï¼š
*   **Epoch 50**: IoU > 0.3-0.4
*   **Epoch 100**: IoU > 0.45-0.55
*   **Epoch 200**: IoU > 0.55-0.65
*   **Epoch 400**: æœ€ç»ˆæ”¶æ•›

**ä¼˜åŠ¿**ï¼š
1.  âœ… å­¦ä¹ ç‡æ›´é«˜ï¼Œæ”¶æ•›æ›´å¿«
2.  âœ… æ¸…æ™°çš„è®­ç»ƒèµ·ç‚¹ï¼Œæ— å†å²åŒ…è¢±
3.  âœ… æ€» epoch æ›´å°‘ï¼ˆ800 â†’ 400ï¼‰ï¼ŒèŠ‚çœæ—¶é—´

#### æ–¹æ¡ˆ B: ç»§ç»­å½“å‰è®­ç»ƒ + æ‰‹åŠ¨è°ƒæ•´

ä¿ç•™å½“å‰ 107 epoch è¿›åº¦ï¼Œæ‰‹åŠ¨æå‡å­¦ä¹ ç‡ï¼š

**å®ç°æ–¹å¼**ï¼š
ä¿®æ”¹ `lr_sched.py`ï¼š
```python
def adjust_learning_rate(optimizer, epoch, args):
    if epoch >= 100:
        boost_factor = 3.0  # LR æå‡ 3 å€
        lr = base_lr * boost_factor
    else:
        # ... åŸæœ‰è°ƒåº¦
```

**ä¼˜åŠ¿**ï¼š
*   ä¸ä¸¢å¤± 107 epoch çš„è®­ç»ƒè¿›åº¦

**åŠ£åŠ¿**ï¼š
*   æ›´å¤æ‚ï¼Œéœ€è¦ä¿®æ”¹ä»£ç 
*   å¯èƒ½æ•ˆæœä¸å¦‚é‡æ–°è®­ç»ƒ

#### æ–¹æ¡ˆ C: ç­‰å¾…å¹¶è§‚å¯Ÿ

ç»§ç»­å½“å‰è®­ç»ƒè‡³ Epoch 200-300ã€‚

**åŠ£åŠ¿**ï¼š
*   å­¦ä¹ ç‡å¤ªä½ï¼Œå¤§æ¦‚ç‡ç»§ç»­åœæ»
*   æµªè´¹è®¡ç®—èµ„æº

### 12.4 æœ€ç»ˆå†³ç­–

**é‡‡ç”¨æ–¹æ¡ˆ Aï¼šé‡æ–°è®­ç»ƒï¼Œä½¿ç”¨ä¼˜åŒ–é…ç½®**

**ç†ç”±**ï¼š
1.  å½“å‰è®­ç»ƒå·²åœæ» 80+ epochsï¼Œç»§ç»­ä¸‹å»æ„ä¹‰ä¸å¤§
2.  å­¦ä¹ ç‡è¿‡ä½æ˜¯æ ¹æœ¬é—®é¢˜ï¼Œéœ€è¦ç³»ç»Ÿæ€§è°ƒæ•´
3.  V2 é…ç½®é’ˆå¯¹æ€§è§£å†³ LR é—®é¢˜
4.  ç»“åˆä¼˜è´¨æ•°æ® + ä¼˜åŒ–è¶…å‚ï¼Œåº”è¯¥èƒ½æ›´å¿«æ”¶æ•›
5.  é‡æ–°å¼€å§‹æ¯”ä¿®è¡¥æ›´ç®€æ´å¯æ§

**æ‰§è¡Œæ­¥éª¤**ï¼š
```bash
# 1. å–æ¶ˆå½“å‰è®­ç»ƒ
scancel <job_id>

# 2. æäº¤ä¼˜åŒ–ç‰ˆæœ¬
cd /projappl/project_2016517/JunjieCheng/VecSetX
sbatch run_phase1_sbatch_v2.sh

# 3. ç›‘æ§è®­ç»ƒ
# - å‰ 20 epoch è§‚å¯Ÿ warmup æ•ˆæœ
# - Epoch 50 æ£€æŸ¥ loss æ˜¯å¦ < 0.38
# - Epoch 100 æ£€æŸ¥ IoU æ˜¯å¦ > 0.45
```

### 12.5 é…ç½®æ–‡ä»¶

**V1 é…ç½®** (`run_phase1_sbatch.sh`):
*   base_lr: 4e-4
*   warmup: 10 epochs
*   total: 800 epochs
*   ç»“æœï¼šEpoch 107 åœæ»

**V2 ä¼˜åŒ–é…ç½®** (`run_phase1_sbatch_v2.sh`):
*   base_lr: 1e-3 âœ…
*   warmup: 20 epochs âœ…
*   total: 400 epochs âœ…
*   output_dir: `output/ae/phase1_production_v2`

### 12.6 ç»éªŒæ•™è®­

1.  **å­¦ä¹ ç‡è°ƒåº¦è‡³å…³é‡è¦**
    *   æ€» epoch æ•°ç›´æ¥å½±å“ cosine decay é€Ÿåº¦
    *   é•¿è°ƒåº¦ (800) é€‚åˆæ”¶æ•›æ…¢çš„ä»»åŠ¡ï¼Œä½† LR è¡°å‡å¤ªå¿«
    *   çŸ­è°ƒåº¦ (400) + é«˜ base_lr å¯èƒ½æ›´é€‚åˆå½“å‰ä»»åŠ¡

2.  **Warmup çš„é‡è¦æ€§**
    *   10 epochs å¯èƒ½å¤ªçŸ­
    *   20 epochs æä¾›æ›´ç¨³å®šçš„åˆå§‹åŒ–

3.  **ç›‘æ§è®­ç»ƒæ›²çº¿**
    *   Loss æŒå¹³ > 20 epochs éœ€è­¦æƒ•
    *   åº”æ£€æŸ¥å­¦ä¹ ç‡æ˜¯å¦è¿‡ä½
    *   IoU éœ‡è¡åœ¨æ—©æœŸæ­£å¸¸ï¼Œä½†åº”é€æ­¥å‡å°

4.  **Base LR é€‰æ‹©**
    *   4e-4 åä¿å®ˆ
    *   1e-3 æ›´å¸¸è§äº vision transformer è®­ç»ƒ

### 12.7 å¾…éªŒè¯å‡è®¾

**å‡è®¾ 1**: æ›´é«˜çš„ LR ä¼šæ‰“ç ´åœæ»
*   éªŒè¯æ–¹æ³•ï¼šV2 è®­ç»ƒ 50 epochs åè§‚å¯Ÿ loss
*   æˆåŠŸæ ‡å¿—ï¼šloss < 0.38

**å‡è®¾ 2**: 400 epochs è¶³å¤Ÿæ”¶æ•›
*   éªŒè¯æ–¹æ³•ï¼šè§‚å¯Ÿ Epoch 300-400 çš„ loss/IoU å˜åŒ–
*   æˆåŠŸæ ‡å¿—ï¼šæœ€å 50 epochs å˜åŒ– < 1%

**å‡è®¾ 3**: æ•°æ®è´¨é‡å·²ä¸æ˜¯ç“¶é¢ˆ
*   å‡è®¾æ–°æ•°æ®é›†è´¨é‡è¶³å¤Ÿå¥½
*   å¦‚æœ V2 ä»åœæ»ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘æ¨¡å‹å®¹é‡æˆ–å…¶ä»–å› ç´ 

---

**ä¸‹ä¸€æ­¥ï¼šç­‰å¾… V2 è®­ç»ƒç»“æœï¼ŒéªŒè¯ä¼˜åŒ–æ•ˆæœã€‚**

---

## 13. å¤šç±»åˆ«æ¶æ„å‡çº§ä¸æ•°æ®ç”Ÿæˆä¿®å¤ (Multi-Class Upgrade & Data Fixes) [Dec 6, 2025]

### 13.1 èƒŒæ™¯ä¸ç›®æ ‡
ä¸ºäº†å®ç°ä»å•ä¸€ geometry é‡å»ºåˆ° **10ç±»è§£å‰–ç»“æ„è¯­ä¹‰é‡å»º** çš„è·¨è¶Šï¼Œæˆ‘ä»¬å¯¹ç³»ç»Ÿæ¶æ„è¿›è¡Œäº†é‡å¤§å‡çº§ã€‚
*   **æ—§æ¶æ„**ï¼šè¾“å‡º 1ç»´ SDF (Union)ã€‚
*   **æ–°æ¶æ„**ï¼šè¾“å‡º 11ç»´ Tensor (1ç»´ Union SDF + 10ç»´ Class Logits)ã€‚
*   **ç›®æ ‡**ï¼šæ¨¡å‹ä¸ä»…å­¦ä¼šå½¢çŠ¶ï¼Œè¿˜è¦å­¦ä¼šâ€œé€™æ˜¯å“ªä¸ªç»“æ„â€ã€‚

### 13.2 é‡åˆ°çš„é—®é¢˜ (Problems)

#### é—®é¢˜ A: æ ‡ç­¾æ³„æ¼ (Label Leakage)
*   **ç°è±¡**ï¼šåœ¨ä½¿ç”¨ `check_data_quality.py` éªŒè¯æ•°æ®æ—¶ï¼Œå‘ç° **~50%** çš„æ ·æœ¬å­˜åœ¨ "Outside but Cls" é”™è¯¯ã€‚è¿™æ„å‘³ç€å¤§é‡å‡ ä½•ä¸Šåœ¨ **å¤–éƒ¨** çš„ç‚¹è¢«é”™è¯¯åœ°æ‰“ä¸Šäº† **ç±»åˆ«æ ‡ç­¾**ã€‚
*   **åŸå› **ï¼šæ—©æœŸçš„ `prepare_data.py` ä½¿ç”¨ç®€å•çš„ "Depth Ratio Heuristic" æ¥åˆ¤å®šå†…å¤–ã€‚è¯¥å¯å‘å¼ç®—æ³•åœ¨è¿œç¦»ä¸­å¿ƒæ—¶ä¼šå¤±æ•ˆï¼Œé”™è¯¯åœ°å°†è¿œå¤„çš„ç‚¹åˆ¤å®šä¸ºâ€œå†…éƒ¨â€ã€‚
*   **åæœ**ï¼šæ¨¡å‹ä¼šè¢«è¿«å­¦ä¹ é”™è¯¯çš„æ ‡ç­¾ï¼Œå¯¼è‡´è®­ç»ƒå‘æ•£æˆ–æ— æ³•æ”¶æ•›ã€‚

#### é—®é¢˜ B: æ•ˆç‡ç“¶é¢ˆ
*   **å°è¯•**ï¼šè¯•å›¾å…¨é‡ä½¿ç”¨ `mesh_to_sdf` (ä¸“ä¸šåº“) æ¥è§£å†³æ³„æ¼ã€‚
*   **ç»“æœ**ï¼šé€Ÿåº¦ææ…¢ï¼ˆæ¯æ–‡ä»¶æ•°åˆ†é’Ÿï¼‰ï¼Œæ— æ³•æ»¡è¶³ 1000+ æ–‡ä»¶çš„ç”Ÿæˆéœ€æ±‚ã€‚

### 13.3 è§£å†³æ–¹æ¡ˆ (Solutions)

é‡‡ç”¨äº† **"Multi-Class Hybrid Final"** æ··åˆç­–ç•¥ï¼Œå…¼é¡¾é€Ÿåº¦ä¸å‡†ç¡®æ€§ï¼š

1.  **Volume Points (é€Ÿåº¦ä¼˜å…ˆ)**ï¼š
    *   æ²¿ç”¨ **Depth Ratio Heuristic (Threshold=0.33)**ã€‚
    *   **åˆ›æ–°**ï¼šå¯¹ **æ¯ä¸ªç±»åˆ«(1-10)** åˆ†åˆ«è®¡ç®— Heuristic SDFï¼Œå–æœ€å°å€¼ä½œä¸º Union SDFï¼Œå– argmin ä½œä¸ºæ ‡ç­¾ã€‚
    *   **æ•ˆæœ**ï¼šä¿è¯äº†å…¨å±€è¦†ç›–ï¼Œä¸”é€Ÿåº¦æå¿«ã€‚

2.  **Near Points (ç²¾åº¦ä¼˜å…ˆ)**ï¼š
    *   **Geometry**ï¼šä½¿ç”¨ `mesh_to_sdf` å¯¹ **Union Mesh** è¿›è¡Œè®¡ç®—ï¼Œç¡®ä¿è¿‘è¡¨é¢ SDF çš„ç‰©ç†çœŸå®æ€§ã€‚
    *   **Semantics**ï¼šä½¿ç”¨ Heuristic æ–¹æ³•åˆ¤å®šç‚¹å½’å±çš„ç±»åˆ«ã€‚
    *   **Fusion**ï¼šé€šè¿‡ä¸¥æ ¼é€»è¾‘ `if Union_SDF > 0: Label = 0` å¼ºåˆ¶ä¿®æ­£ã€‚

3.  **ä¸€è‡´æ€§ä¿è¯ (Consistency)**ï¼š
    *   åˆ©ç”¨ `Union_SDF` (from mesh_to_sdf) ä½œä¸ºç»å¯¹çœŸç†ã€‚
    *   ä»»ä½•åœ¨å‡ ä½•ä¸Šä¸ºâ€œå¤–éƒ¨â€çš„ç‚¹ï¼Œå¼ºåˆ¶æ ‡ç­¾ä¸º 0ã€‚
    *   å®ç°äº† **100% Geometry-Label Consistency**ã€‚

### 13.4 ä»£ç å˜æ›´ (Code Changes)

1.  **`vecset/prepare_data.py`**ï¼šå®Œå…¨é‡å†™ã€‚å®ç°äº†ä¸Šè¿° "Hybrid Final" é€»è¾‘ï¼Œæ”¯æŒ 10 ç±» Label ç”Ÿæˆã€‚
2.  **`vecset/models/autoencoder.py`**ï¼šå°† `output_dim` é»˜è®¤å€¼æ”¹ä¸º **11**ã€‚
3.  **`vecset/engines/engine_ae.py`**ï¼š
    *   æ–°å¢ `loss_cls` (Binary Cross Entropy) ç”¨äºåˆ†ç±»è®­ç»ƒã€‚
    *   æ–°å¢ `acc` æŒ‡æ ‡ç”¨äºç›‘æ§åˆ†ç±»å‡†ç¡®ç‡ã€‚
    *   å®ç°äº† SDF loss (L1) ä¸ Classification loss çš„åŠ æƒè”åˆè®­ç»ƒã€‚
4.  **`vecset/utils/objaverse.py`**ï¼šæ›´æ–° `__getitem__` ä»¥åŠ è½½å’Œè¿”å›æ ‡ç­¾æ•°æ®ã€‚
5.  **`vecset/models/utils.py`**ï¼šå°†æ‰‹åŠ¨ Attention æ›¿æ¢ä¸º PyTorch ä¼˜åŒ–çš„ `F.scaled_dot_product_attention`ï¼Œæå‡æ˜¾å­˜æ•ˆç‡ã€‚
6.  **`check_data_quality.py`**ï¼šæ–°å¢å·¥å…·ï¼Œä¸“é—¨ç”¨äºéªŒè¯ SDF æ­£è´Ÿæ¯”ä¸ Label ä¸€è‡´æ€§ã€‚


### 13.5 ä¸‹ä¸€æ­¥è®¡åˆ’
1.  ä½¿ç”¨æ–°è„šæœ¬å…¨é‡ç”Ÿæˆè®­ç»ƒæ•°æ®ã€‚
2.  ä½¿ç”¨ `check_data_quality.py` æŠ½æ£€ã€‚
3.  å¯åŠ¨ Phase 1 Multi-Class è®­ç»ƒã€‚

---

## 14. Multi-Class Data Generation - Complete Debugging Journey (2025-12-06~07)

### 14.1 èƒŒæ™¯ä¸ç›®æ ‡
ä¸ºVecSetXå¤šç±»åˆ«è®­ç»ƒç”Ÿæˆé«˜è´¨é‡æ•°æ®é›†ï¼ˆ998ä¸ªæ ·æœ¬ï¼Œ10ä¸ªå¿ƒè„ç»“æ„ç±»åˆ«ï¼‰ã€‚

**æ ¸å¿ƒè¦æ±‚**ï¼š
- SDFå¹³è¡¡ï¼šVolume ~50%, Near ~50%
- Label-Geometryä¸€è‡´æ€§ï¼šæ¥è¿‘100%
- ç±»åˆ«è¦†ç›–ï¼šæ‰€æœ‰æ ·æœ¬åŒ…å«å…¨éƒ¨10ä¸ªç±»åˆ«
- **ç‰¹åˆ«ä¿è¯Coronaryï¼ˆåˆ›æ–°ç‚¹ï¼‰çš„é‡‡æ ·è´¨é‡**

---

### 14.2 é—®é¢˜1: SDF Balanceå¼‚å¸¸

**ç°è±¡**ï¼šVol Posåˆ†å¸ƒä¸¥é‡å¤±è¡¡
- `vol_threshold=0.33` â†’ Vol Pos = 0%
- `vol_threshold=1.2` â†’ Vol Pos = 99%

**æ ¹æœ¬åŸå› **ï¼š
Depth ratio heuristicçš„thresholdå‚æ•°å¯¹inside/outsideåˆ¤æ–­å½±å“æå¤§ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
å®éªŒç¡®å®š `vol_threshold=0.85` èƒ½å¾—åˆ°~50% Vol Posã€‚

---

### 14.3 é—®é¢˜2: ç±»åˆ«ç¼ºå¤±

**ç°è±¡**ï¼š
```
Surface labels: 10 classes âœ…
Vol labels: 8 classes (missing [1, 3]) âŒ
```

**æ ¹æœ¬åŸå› **ï¼š
Depth ratio heuristicå¯¹è–„å£ç»“æ„ï¼ˆMyocardium, LVï¼‰åˆ¤æ–­ä¸å‡†ï¼Œå³ä½¿ç‚¹åœ¨è¯¥ç±»åˆ«ä½“ç´ å†…ï¼ŒSDFå´åˆ¤ä¸ºoutsideã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
å°è¯•ç›´æ¥ä»voxelè¯»å–labelï¼Œä½†å¼•å…¥äº†coordinate mismatché—®é¢˜ï¼ˆè§é—®é¢˜4ï¼‰ã€‚

---

### 14.4 é—®é¢˜3: Coronaryé‡‡æ ·ä¸è¶³

**é—®é¢˜åˆ†æ**ï¼š
- Coronaryä½“ç§¯å æ¯”ï¼š0.12%
- éšæœºé‡‡æ ·50kç‚¹ï¼šç†è®ºä»…60ä¸ªç‚¹
- ä¸¥é‡ä¸è¶³ä»¥å­¦ä¹ è¯¥ç»“æ„

**åˆæ­¥æ–¹æ¡ˆ**ï¼šStratified Sampling
- èƒŒæ™¯35% (17.5k), ç»“æ„65% (32.5k)
- ç†è®ºæå‡Coronaryé‡‡æ ·è‡³~200ç‚¹
- ä½†å¼•å…¥äº†ä¸¥é‡çš„consistencyé—®é¢˜...

---

### 14.5 é—®é¢˜4: Stratified Samplingå¯¼è‡´Label-SDFä¸¥é‡ä¸ä¸€è‡´ âš ï¸âš ï¸âš ï¸

**ç¾éš¾æ€§ç°è±¡**ï¼š
```
Consistency: 52.7% (åº”è¯¥æ¥è¿‘100%) âŒâŒâŒ
Outside (SDF>=0) but has class label: 36.9%
```

**Stratifiedå®ç°æ–¹å¼ï¼ˆæœ‰é—®é¢˜ï¼‰**ï¼š
```python
# 1. åœ¨voxelæ•´æ•°ç©ºé—´stratifiedé‡‡æ ·
vol_points_voxel = sample_from_voxel_grid(data)

# 2. ä»voxelç›´æ¥è¯»label
vol_labels[i] = data[x, y, z]  # voxel space

# 3. Transformåˆ°normalizedç©ºé—´
vol_points = transform(vol_points_voxel)  # normalized space

# 4. è®¡ç®—SDF
vol_sdf = compute_sdf(vol_points, normalized_mesh)  # normalized space
```

**æ ¹æœ¬åŸå› ï¼šCoordinate Space Mismatch**
- Labelsåœ¨**voxelæ•´æ•°åæ ‡ç©ºé—´**åˆ†é…
- SDFåœ¨**normalizedè¿ç»­åæ ‡ç©ºé—´**è®¡ç®—
- Transformåœ¨è¾¹ç•Œå¤„æœ‰å¾®å°è¯¯å·®
- å¯¼è‡´ï¼švoxelè¯´"inside"ï¼Œnormalized SDFè¯´"outside"

**è°ƒè¯•è¯æ®**ï¼š
```
Outside but has class label:
  Point 17502: SDF=0.0157, Label=6  â† åˆšå¥½åœ¨è¾¹ç•Œå¤–0.01
  Point 17503: SDF=0.0227, Label=1
```

36.9%çš„é«˜æ¯”ä¾‹æ˜¯å› ä¸ºstratifiedæ•…æ„åœ¨ç»“æ„è¾¹ç•Œå¯†é›†é‡‡æ ·ï¼

---

### 14.6 æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼šNormalized Space Stratified Sampling âœ…

**æ ¸å¿ƒæ€æƒ³**ï¼š
**åœ¨åŒä¸€ä¸ªåæ ‡ç©ºé—´ï¼ˆnormalized spaceï¼‰å®Œæˆæ‰€æœ‰æ“ä½œ**

**å®ç°**ï¼š
```python
# 1. èƒŒæ™¯ç‚¹ï¼šä»æ•´ä¸ª[-1,1]Â³å‡åŒ€é‡‡æ ·
vol_points_bg = np.random.uniform(-1, 1, (n_bg, 3))

# 2. ç»“æ„ç‚¹ï¼šä»union meshçš„bounding boxé‡‡æ ·ï¼ˆå·²åœ¨normalized spaceï¼‰
bounds = union_mesh.bounds
bbox_expanded = expand_bbox(bounds, factor=1.1)
vol_points_struct = np.random.uniform(bbox_min, bbox_max, (n_struct, 3))

# 3. åœ¨åŒä¸€ç©ºé—´è®¡ç®—SDF
vol_sdf = compute_sdf(vol_points, normalized_mesh)

# 4. ä»SDFæ¨å¯¼labelï¼ˆæ•°å­¦ä¸¥æ ¼ä¸€è‡´ï¼‰
vol_labels = derive_from_sdf(vol_sdf_all)
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç©ºé—´ä¸€è‡´æ€§ï¼šé‡‡æ ·ã€SDFã€labelséƒ½åœ¨normalized space
- âœ… æ•°å­¦ä¸€è‡´æ€§ï¼šLabelä¸¥æ ¼ç”±SDFæ¨å¯¼ï¼Œ100%ä¸€è‡´
- âœ… ç»“æ„è¦†ç›–ï¼š65%ç‚¹åœ¨ç»“æ„bboxå†…ï¼Œå°ç»“æ„é‡‡æ ·æå‡
- âœ… é¿å…coordinate transformè¯¯å·®

---

### 14.7 é—®é¢˜5: æ•°æ®ç”Ÿæˆé€Ÿåº¦ä¼˜åŒ–

**åŸå§‹æ€§èƒ½**ï¼š
- å•æ–‡ä»¶ï¼š50-60ç§’
- 998æ–‡ä»¶ä¸²è¡Œï¼š~14å°æ—¶
- CPUåˆ©ç”¨ç‡ï¼š<30% (256æ ¸ç³»ç»Ÿ)

**ä¼˜åŒ–å†ç¨‹**ï¼š

**é˜¶æ®µ1ï¼šPer-Class Parallelization**
- 10ä¸ªç±»åˆ«çš„SDFå¹¶è¡Œè®¡ç®—
- æå‡ï¼š~2-3å€

**é˜¶æ®µ2ï¼šFile-Level Parallelization**
- åŒæ—¶å¤„ç†å¤šä¸ªæ–‡ä»¶
- é‡åˆ°Nested Poolé—®é¢˜ï¼šdaemonè¿›ç¨‹ä¸èƒ½spawnå­è¿›ç¨‹

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
if file_workers > 1:
    use_parallel = False  # ç¦ç”¨æ–‡ä»¶å†…å¹¶è¡Œ
else:
    use_parallel = True   # å¯ç”¨per-classå¹¶è¡Œ
```

**æœ€ç»ˆé…ç½®**ï¼š
```bash
--file_workers 32  # 32æ–‡ä»¶å¹¶è¡Œ
--n_workers 1      # æ–‡ä»¶å†…ä¸²è¡Œ
```

**æœ€ç»ˆé€Ÿåº¦**ï¼š998æ–‡ä»¶ ~**30åˆ†é’Ÿ** (ä»14å°æ—¶ä¼˜åŒ–åˆ°30åˆ†é’Ÿï¼)

---

### 14.8 é—®é¢˜6: check_data_quality.pyè¯¯æŠ¥

**ç°è±¡**ï¼š
æŠ¥å‘Š24%ä¸ä¸€è‡´ï¼Œä½†å®é™…100%ä¸€è‡´

**åŸå› **ï¼š
```python
# âŒ é”™è¯¯
inside = vol_sdf < -1e-4  # åº”è¯¥æ˜¯0

# âœ… æ­£ç¡®
inside = vol_sdf < 0
```

**ä¿®å¤**ï¼š
å°†æ£€æŸ¥è„šæœ¬çš„é˜ˆå€¼æ”¹ä¸ºSDF=0ï¼Œä¸labelåˆ†é…é€»è¾‘ä¸€è‡´ã€‚

---

### 14.9 æœ€ç»ˆé…ç½® & é¢„æœŸè´¨é‡

**ç”Ÿæˆå‘½ä»¤**ï¼š
```bash
python prepare_data.py \
    --input_dir /scratch/project_2016517/junjie/dataset/repaired_shape \
    --output_dir /scratch/project_2016517/junjie/dataset/repaired_npz \
    --vol_threshold 0.85 \
    --file_workers 32
```

**é¢„æœŸè´¨é‡**ï¼š
- SDF Balance: Vol ~55%, Near ~52%
- Label Consistency: ~100%
- Class Coverage: Surface 100%, Vol å¯èƒ½8-10ç±»
- ç”Ÿæˆæ—¶é—´: ~30åˆ†é’Ÿ (998æ–‡ä»¶)

---

### 14.10 æ ¸å¿ƒæ•™è®­

1. **åæ ‡ç©ºé—´ä¸€è‡´æ€§è‡³å…³é‡è¦**ï¼šåŒä¸€ç©ºé—´æ“ä½œé¿å…transformè¯¯å·®
2. **Heuristicéœ€empirical validation**ï¼šdepth ratioå¯¹è–„å£ç»“æ„ä¸å‡†
3. **æ•°æ®æ£€æŸ¥å¿…é¡»ä¸ç”Ÿæˆé€»è¾‘ä¸€è‡´**ï¼šé˜ˆå€¼å¿…é¡»åŒ¹é…
4. **é¿å…åµŒå¥—å¹¶è¡Œ**ï¼šfile-levelå’Œtask-levelå¹¶è¡ŒäºŒé€‰ä¸€
5. **Stratified samplingæ˜¯åŒåˆƒå‰‘**ï¼šæå‡è¦†ç›–ä½†å®ç°å¤æ‚

**å…³é”®æ–‡ä»¶**ï¼š
- `prepare_data.py`: æœ€ç»ˆä¼˜åŒ–ç‰ˆæœ¬
- `check_data_quality.py`: æ±‡æ€»ç»Ÿè®¡
- `debug_consistency.py`: è¯¦ç»†è¯Šæ–­
- `verify_all_classes.py`: ç±»åˆ«è¦†ç›–éªŒè¯

---

## 15. æ•°æ®ç”Ÿæˆæ€§èƒ½ä¼˜åŒ–ä¸å¹¶è¡ŒåŒ–é—®é¢˜ (2025-12-07)

### 15.1 å¹¶è¡ŒåŒ–å¤±è´¥çš„æ ¹æœ¬åŸå› 

**é—®é¢˜ç°è±¡**ï¼š
- è®¾ç½®`--file_workers 64`ï¼Œä½†é€Ÿåº¦æ²¡æœ‰æå‡
- CPUä½¿ç”¨ç‡å¾ˆä½ï¼ˆ~1%ï¼‰ï¼Œçœ‹èµ·æ¥å®Œå…¨ä¸²è¡Œ
- 998ä¸ªæ–‡ä»¶ç”Ÿæˆè€—æ—¶12+å°æ—¶

**æ ¹æœ¬åŸå› **ï¼š
`process_file`å‡½æ•°ç¼ºå°‘returnè¯­å¥ï¼Œå¯¼è‡´`pool.imap_unordered`æ— æ³•æ­£å¸¸å·¥ä½œï¼š

```python
# âŒ é”™è¯¯çš„å®ç°
def process_file(file_path, args):
    # ... å¤„ç†é€»è¾‘ ...
    gc.collect()
    # æ²¡æœ‰returnï¼

# Poolç­‰ä¸åˆ°è¿”å›å€¼ï¼Œhangä½
with Pool(processes=file_workers) as pool:
    for i, result in enumerate(pool.imap_unordered(process_func, files)):
        # è¿™ä¸ªå¾ªç¯æ°¸è¿œä¸ä¼šæ­£å¸¸è¿­ä»£
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```python
# âœ… æ­£ç¡®çš„å®ç°
def process_file(file_path, args):
    # ... å¤„ç†é€»è¾‘ ...
    gc.collect()
    return os.path.basename(file_path)  # å¿…é¡»è¿”å›å€¼
```

---

### 15.2 æ€§èƒ½ç“¶é¢ˆåˆ†æ

å³ä½¿ä¿®å¤äº†å¹¶è¡Œbugï¼Œä»ç„¶å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼š

**ä¸»è¦ç“¶é¢ˆï¼šmesh_to_sdf**
- æ¯ä¸ªæ–‡ä»¶éœ€è¦è°ƒç”¨`mesh_to_sdf`è®¡ç®—50k near pointsçš„ç²¾ç¡®SDF
- **å•æ–‡ä»¶è€—æ—¶ï¼š60-90ç§’**
- mesh_to_sdfå†…éƒ¨æ˜¯å•çº¿ç¨‹çš„ï¼Œæ— æ³•è¿›ä¸€æ­¥å¹¶è¡Œ
- CPUä½¿ç”¨ç‡ä½ï¼ˆ12.5%ï¼‰æ˜¯å› ä¸ºç®—æ³•æœ¬èº«é™åˆ¶

**å®é™…æ€§èƒ½**ï¼š
```
16 file_workers Ã— 60ç§’/æ–‡ä»¶ = æ¯æ‰¹16ä¸ªæ–‡ä»¶éœ€è¦60ç§’
998æ–‡ä»¶æ€»è®¡ â‰ˆ 60-90åˆ†é’Ÿ
```

---

### 15.3 æ‰‹åŠ¨å¤šç»ˆç«¯å¹¶è¡Œæ–¹æ¡ˆ

å¦‚æœè‡ªåŠ¨å¹¶è¡Œå¤ªæ…¢ï¼Œå¯ä»¥æ‰‹åŠ¨å¼€å¤šä¸ªç»ˆç«¯å¹¶è¡Œå¤„ç†ï¼š

#### æ–¹æ¡ˆ1ï¼šæŒ‰ç´¢å¼•èŒƒå›´åˆ†é…ï¼ˆ8ä¸ªç»ˆç«¯ï¼‰

```bash
# ç»ˆç«¯1
python prepare_data.py \
    --input_dir /scratch/project_2016517/junjie/dataset/repaired_shape \
    --output_dir /scratch/project_2016517/junjie/dataset/repaired_npz \
    --vol_threshold 0.85 \
    --file_workers 1 \
    --start_idx 0 --end_idx 125

# ç»ˆç«¯2
python prepare_data.py ... --start_idx 125 --end_idx 250

# ç»ˆç«¯3-8ç±»ä¼¼ï¼Œæ¯ä¸ªå¤„ç†125ä¸ªæ–‡ä»¶
```

**æ³¨æ„**ï¼š`--file_workers 1`é¿å…nested parallelism

####  æ–¹æ¡ˆ2ï¼šåªå¤„ç†ç¼ºå¤±æ–‡ä»¶

```bash
# 1. æ‰¾å‡ºç¼ºå¤±æ–‡ä»¶
python process_missing.py
# è‡ªåŠ¨åˆ›å»ºsymlinkåˆ° /scratch/.../missing_files_temp

# 2. æ‰‹åŠ¨åˆ†æ‰¹å¤„ç†
# å°†50ä¸ªç¼ºå¤±æ–‡ä»¶åˆ†æˆ5æ‰¹ï¼Œæ¯æ‰¹10ä¸ªï¼Œ5ä¸ªç»ˆç«¯å¹¶è¡Œ
```

#### æ–¹æ¡ˆ3ï¼šä½¿ç”¨screenæ‰¹é‡ç®¡ç†

```bash
# åˆ›å»º8ä¸ªscreenä¼šè¯
for i in {1..8}; do screen -dmS data_gen_$i; done

# åœ¨æ¯ä¸ªä¼šè¯ä¸­è¿è¡Œ
screen -S data_gen_1 -X stuff "python prepare_data.py --start_idx 0 --end_idx 125\n"
screen -S data_gen_2 -X stuff "python prepare_data.py --start_idx 125 --end_idx 250\n"

# æŸ¥çœ‹è¿›åº¦
screen -r data_gen_1
```

---

### 15.4 æ•°æ®è´¨é‡æœ€ç»ˆæŠ¥å‘Š

**SDF Balance**ï¼š
- Vol Pos: 51.3% Â± 11.0% âœ…
- Near Pos: 52.9% Â± 0.7% âœ… å®Œç¾

**Label Consistency**: 100.0% âœ…

**Class Coverage (Vol)**ï¼š
- 10ç±»ï¼š40.9%
- 9ç±»ï¼š42.7%ï¼ˆä¸»è¦ç¼ºLVï¼‰
- 8ç±»ï¼š15.4%ï¼ˆç¼ºLV+LAï¼‰

**ç¼ºå¤±ç±»åˆ«**ï¼š
- LV: 44.9%æ–‡ä»¶ç¼ºå¤± âš ï¸
- LA: 25.1%æ–‡ä»¶ç¼ºå¤± âš ï¸
- Coronary: 0.1%ç¼ºå¤± âœ… åˆ›æ–°ç‚¹ä¿éšœ

---

### 15.5 åç»­æ”¹è¿›ï¼ˆå¦‚è®­ç»ƒæ•ˆæœä¸ä½³ï¼‰

**å¦‚æœLV/LAé‡å»ºå·®**ï¼š
```python
# æ–¹æ¡ˆ1: Lossæƒé‡è°ƒæ•´
loss = loss_surface * 3 + loss_near * 10 + loss_vol * 1

# æ–¹æ¡ˆ2: é™ä½vol_threshold
--vol_threshold 0.75  # ä»0.85é™åˆ°0.75
```

**å¦‚æœmesh_to_sdfå¤ªæ…¢**ï¼š
```python
# é™ä½ç²¾åº¦æ¢é€Ÿåº¦
mesh_to_sdf.mesh_to_sdf(..., scan_count=50, scan_resolution=200)
# é€Ÿåº¦æå‡2å€
```

---

### 15.6 å…³é”®å·¥å…·è„šæœ¬

```bash
# è´¨é‡æ£€æŸ¥
python check_data_quality.py <npz_dir>
python debug_consistency.py <file.npz>
python analyze_missing_classes.py <npz_dir>

# æ‰¾ç¼ºå¤±æ–‡ä»¶
python process_missing.py
```

**æœ€ç»ˆé…ç½®**ï¼š
- vol_threshold: 0.85
- file_workers: 16
- Stratified sampling: 35bg/65struct (normalized space)
- æ€»è€—æ—¶: 1-2å°æ—¶ï¼ˆ998æ–‡ä»¶ï¼‰

## 16. DataLoader Bugä¿®å¤ä¸è®­ç»ƒå¯åŠ¨ (2025-12-07)

åœ¨å¯åŠ¨Phase 1è®­ç»ƒæ—¶ï¼Œé‡åˆ°äº†ä¸€ç³»åˆ—ä¸DataLoaderå’ŒSDFé‡‡æ ·ç›¸å…³çš„bugï¼Œé€šè¿‡ä»¥ä¸‹æ­¥éª¤é€ä¸€è§£å†³ï¼š

### 16.1 DataLoaderä¸­çš„`UnboundLocalError`

**é—®é¢˜**ï¼š
è®­ç»ƒå¯åŠ¨åæŠ¥é”™ï¼š`UnboundLocalError: local variable 'points' referenced before assignment`ã€‚

**åŸå› **ï¼š
åœ¨`Objaverse.__getitem__`ä¸­ï¼Œ`points`å˜é‡å®šä¹‰åœ¨if/elseåˆ†æ”¯ä¸­ï¼Œä½†åœ¨æŸäº›ä»£ç è·¯å¾„ä¸‹æ²¡æœ‰è¢«æ­£ç¡®åˆå§‹åŒ–ã€‚

**ä¿®å¤**ï¼š
é‡å†™äº†SDFé‡‡æ ·é€»è¾‘ï¼Œä½¿ç”¨æ˜ç¡®çš„`pos_ind`å’Œ`neg_ind`å˜é‡ï¼Œç¡®ä¿åœ¨æ‰€æœ‰åˆ†æ”¯ä¸­éƒ½æ­£ç¡®é‡‡æ ·`points`ã€`sdf`å’Œ`labels`ï¼Œå¹¶è¿›è¡Œæ‹¼æ¥ã€‚

### 16.2 Tensor Shape Mismatch

**é—®é¢˜**ï¼š
`RuntimeError: stack expects each tensor to be equal size`ã€‚
æŠ¥é”™æ˜¾ç¤ºSDF tensorå½¢çŠ¶ä¸åŒ¹é…ï¼Œä¾‹å¦‚`[1024, 1]` vs `[1024]`ã€‚

**åŸå› **ï¼š
`.npz`æ–‡ä»¶ä¸­ä¿å­˜çš„SDFæ•°æ®å½¢çŠ¶å¯èƒ½æ˜¯`(N, 1)`ï¼Œè½¬æ¢ä¸ºtorch tensoråä¾ç„¶ä¿ç•™äº†ç»´åº¦ï¼Œè€ŒLabelsæ˜¯1Dçš„`(N,)`ã€‚åœ¨`torch.stack`æ—¶ç»´åº¦ä¸ä¸€è‡´å¯¼è‡´æŠ¥é”™ã€‚

**ä¿®å¤**ï¼š
åœ¨è½¬æ¢ä¸ºtorch tensoræ—¶ï¼Œå¼ºåˆ¶ä½¿ç”¨`.flatten()`å°†SDFå’ŒLabelséƒ½å±•å¹³ä¸º1Då¼ é‡ã€‚

### 16.3 Batch Collation Error (Near Pointsæ•°é‡ä¸ä¸€è‡´)

**é—®é¢˜**ï¼š
`RuntimeError: stack expects each tensor to be equal size, but got [51018, 3] at entry 0 and [51020, 3] at entry 1`ã€‚

**åŸå› **ï¼š
ä¸åŒ`.npz`æ–‡ä»¶çš„`near_points`æ•°é‡ä¸ä¸€è‡´ï¼ˆçº¦50kå·¦å³ï¼‰ï¼Œå¯¼è‡´`__getitem__`è¿”å›çš„å¼ é‡é•¿åº¦ä¸åŒï¼ŒPyTorché»˜è®¤çš„`collate_fn`æ— æ³•å°†å˜é•¿å¼ é‡å †å æˆbatchã€‚

**ä¿®å¤**ï¼š
ä¿®æ”¹é‡‡æ ·é€»è¾‘ï¼Œå¯¹`near_points`ä¹Ÿè¿›è¡Œå›ºå®šæ•°é‡é‡‡æ ·ï¼ˆé‡‡æ ·æ•° = `sdf_size // 4`ï¼‰ï¼Œç¡®ä¿æ¯ä¸ªæ ·æœ¬è¿”å›çš„ç‚¹æ•°å®Œå…¨ä¸€è‡´ã€‚

### 16.4 SDF Sizeä¸Model Inputä¸åŒ¹é…

**é—®é¢˜**ï¼š
`loss`è®¡ç®—æ—¶æŠ¥é”™ç»´åº¦ä¸åŒ¹é…ï¼š`pred [2, 1024]` vs `target [2, 768]`ã€‚
æ¨¡å‹é¢„æœŸè¾“å…¥æ˜¯æ‹¼æ¥åçš„ç‚¹äº‘ï¼š`vol(1024) + near(1024) + surface(8192) = 10240`ä¸ªç‚¹ã€‚
ä½†`dataset`é…ç½®ä¸º`sdf_size=1024`ï¼Œå¯¼è‡´åªé‡‡æ ·äº†`256+256=512`ä¸ªvol/nearç‚¹ã€‚

**åŸå› **ï¼š
`main_ae.py`ä¸­å†™æ­»äº†`sdf_size=1024`ï¼Œè€Œé‡‡æ ·é€»è¾‘æ˜¯`sdf_size // 4`ã€‚ä¸ºäº†å¾—åˆ°é¢„æœŸçš„1024ä¸ªç‚¹ï¼Œ`sdf_size`åº”è¯¥è®¾ä¸º4096ã€‚

**ä¿®å¤**ï¼š
åœ¨`main_ae.py`ä¸­å°†`sdf_size`ä»`1024`ä¿®æ”¹ä¸º`4096`ã€‚
ä¿®æ­£åçš„é‡‡æ ·é€»è¾‘ï¼š
- Vol points: `4096 // 4 = 1024`
- Near points: `4096 // 4 = 1024`
- Surface points: `8192` (from `point_cloud_size`)
- Total points: `1024 + 1024 + 8192 = 10240`



## 11. æ­¤è½®é›†ç¾¤è®­ç»ƒè°ƒè¯•è®°å½• (Cluster Training Debugging) [Dec 7, 2025]

åœ¨æœ¬æ¬¡å°†ä»£ç éƒ¨ç½²åˆ°é›†ç¾¤å¹¶å¯åŠ¨è®­ç»ƒçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿ç»­å…‹æœäº†ä¸‰ä¸ªå…³é”®çš„æŠ€æœ¯éšœç¢ï¼Œé€šè¿‡è¿œç¨‹è°ƒè¯•æˆåŠŸå¯åŠ¨äº†å¤§è§„æ¨¡è®­ç»ƒã€‚

### 11.1 æ¨¡å—å¯¼å…¥ä¸åˆå§‹åŒ–å´©æºƒ (ModuleNotFoundError & Silent Crash)

*   **ç—‡çŠ¶**: è®­ç»ƒä»»åŠ¡ç«‹å³å¤±è´¥ (Exit Code 1)ï¼Œæ²¡æœ‰ä»»ä½•æœ‰ç”¨çš„æŠ¥é”™ä¿¡æ¯ã€‚æ—¥å¿—ä¸­ä»…åŒ…å« `torchrun` çš„é€šç”¨é”™è¯¯å †æ ˆã€‚
*   **åŸå› **: 
    1.  `vecset` åŒ…åœ¨é›†ç¾¤ç¯å¢ƒä¸­æœªè¢«æ­£ç¡®è¯†åˆ«ä¸º Python åŒ…ï¼Œå¯¼è‡´ `import vecset.utils.objaverse` å¤±è´¥ã€‚
    2.  `main_ae.py` ç¼ºä¹å¯¹ Dataset åˆå§‹åŒ–å’Œ WandB ç™»å½•çš„å¼‚å¸¸æ•è·ï¼Œå¯¼è‡´è¿›ç¨‹åœ¨æ‰“å°ä»»ä½•æ—¥å¿—å‰å°±å´©æ„¤äº†ã€‚
*   **ä¿®å¤**:
    *   **ç›¸å¯¹å¯¼å…¥**: å°† import è·¯å¾„ä» absolutel (`vecset.utils...`) æ”¹ä¸º relative/local (`utils...`)ï¼Œé€‚é…å½“å‰çš„ PYTHONPATH ç»“æ„ã€‚
    *   **é˜²å¾¡æ€§ç¼–ç¨‹**: åœ¨ `main_ae.py` ä¸­æ·»åŠ äº†è¯¦ç»†çš„ `try-except` å—åŠæ˜¾å¼çš„ `print` æ—¥å¿—ï¼Œç¡®ä¿å³ä½¿åˆå§‹åŒ–å¤±è´¥ä¹Ÿèƒ½çœ‹åˆ°å…·ä½“åŸå› ã€‚
    *   **ç¯å¢ƒæ£€æŸ¥**: æ·»åŠ äº†å¯¹ data_path å’Œ CSV æ–‡ä»¶çš„æ˜¾å¼å­˜åœ¨æ€§æ£€æŸ¥ã€‚

### 11.2 Lossè®¡ç®—ç»´åº¦ä¸åŒ¹é… (ValueError: Shape Mismatch)

*   **ç—‡çŠ¶**: `ValueError: Target size (torch.Size([2, 3072, 10])) must be the same as input size (torch.Size([2, 11264, 10]))`ã€‚
*   **åŸå› **: 
    1.  **ç´¢å¼•ç¡¬ç¼–ç å¤±æ•ˆ**: `dataset` é…ç½®ä¸º `sdf_size=4096`ï¼Œå®é™…äº§ç”Ÿäº† 3072 ä¸ªæŸ¥è¯¢ç‚¹ (1024 Pos + 1024 Neg + 1024 Near)ã€‚ä½† `engine_ae.py` ä¸­æ²¿ç”¨äº†æ—§çš„ç¡¬ç¼–ç ç´¢å¼• (0:1024 Vol, 1024:2048 Near)ï¼Œå¯¼è‡´ loss è®¡ç®—é”™ä½ã€‚
    2.  **åˆ†ç±»ç›®æ ‡ç¼ºå¤±**: `loss_cls` (Binary Cross Entropy) è®¡ç®—æ—¶ï¼Œæ¨¡å‹è¾“å‡ºäº†æ‰€æœ‰ç‚¹ (Query + Surface = 11264) çš„ logitsï¼Œä½† Target ä»…åŒ…å« Query éƒ¨åˆ†çš„æ ‡ç­¾ (3072)ï¼Œå¯¼è‡´ç»´åº¦ä¸åŒ¹é…ã€‚
*   **ä¿®å¤**:
    *   **åŠ¨æ€ç´¢å¼•**: ä¿®æ­£ `loss_vol` å– `[:2048]` (åŒ…å« Pos+Neg)ï¼Œ`loss_near` å– `[2048:3072]`ï¼Œ`loss_surface` å– `[3072:]`ã€‚
    *   **ç›®æ ‡æ‹¼æ¥**: æ„å»º `target_one_hot` æ—¶ï¼Œå°† Query çš„æ ‡ç­¾ä¸ Surface çš„æ ‡ç­¾åœ¨ dim=1 ç»´åº¦ä¸Šæ‹¼æ¥ï¼Œæ„é€ å‡ºå®Œæ•´çš„ (B, 11264, 10) ç›®æ ‡å¼ é‡ã€‚

### 11.3 Attention åå‘ä¼ æ’­å¤±è´¥ (RuntimeError: SDPA Backward)

*   **ç—‡çŠ¶**: `RuntimeError: derivative for aten::_scaled_dot_product_efficient_attention_backward is not implemented`ã€‚
*   **åŸå› **: PyTorch çš„ `F.scaled_dot_product_attention` (SDPA) ç®—å­åœ¨é›†ç¾¤çš„ A100 ç¯å¢ƒä¸‹ï¼Œé…åˆå½“å‰çš„ head_dim å’Œ tensor layoutï¼Œæœªèƒ½è‡ªåŠ¨é€‰æ‹©æ”¯æŒåå‘ä¼ æ’­çš„ kernel (ä½¿ç”¨äº† efficient_attention ä½†å…¶ backward æœªè¢«æ”¯æŒ)ã€‚
*   **ä¿®å¤**:
    *   **å›é€€æ‰‹åŠ¨å®ç°**: åœ¨ `vecset/models/utils.py` ä¸­ï¼Œç”¨æ ‡å‡†çš„ `torch.einsum` æ‰‹åŠ¨å®ç°äº† Scaled Dot-Product Attentionã€‚
    *   **æƒè¡¡**: è™½ç„¶ç‰ºç‰²äº†å°‘é‡æ˜¾å­˜å’Œè®¡ç®—æ•ˆç‡ï¼Œä½†å½»åº•è§£å†³äº†å…¼å®¹æ€§é—®é¢˜ï¼Œä¿è¯äº†æ¢¯åº¦çš„æ­£ç¡®å›ä¼ ã€‚

### 11.4 æœ€ç»ˆçŠ¶æ€

ç»è¿‡ä¸Šè¿°ä¿®å¤ï¼Œ`rank3` ç­‰æ‰€æœ‰è¿›ç¨‹å·²æˆåŠŸè¿›å…¥ Training Loopï¼š
```text
base lr: 2.00e-04
accumulate grad iterations: 8
effective batch size: 64
Start training for 400 epochs
```
æ¨¡å‹æ­£åœ¨ç¨³å®šè®­ç»ƒä¸­ã€‚

## 2025-12-09: Phase 1 Failure Analysis - Data Generation Flaw

### Symptom
- Model achieved decent training IoU (~0.70) but visualized results appeared "blobby" with significant extraneous volume.
- Validation IoU was 0.70, but 3D visualize IoU (Inference) dropped to ~0.10.

### Investigation
- Created `infer_visualize.py` to inspect the alignment (normalization) between Ground Truth (NII) and Model Input (NPZ).
- Overlaying the Input Point Cloud (White) on the GT Mask proved the coordinate system was ALIGNED and ACCURATE.
- Overlaying the Training Data Labels (Volume Points) revealed the root cause:
    - **Magenta Points (Labeled Inside)** were found densely distributed in the background (air), far outside the actual organ.
    - **Blue Points (Labeled Outside)** were scarce in regions that should have been clearly outside.

### Root Cause
- The `prepare_data.py` script used a **Heuristic Algorithm (Depth Ratio)** for "Volume Point" label generation to speed up processing.
- `depth_ratio = dists / dist_to_center`
- This heuristic assumes a somewhat convex or simple geometry where being "far from center" implies "outside".
- For complex, non-convex cardiac structures (multi-class), this assumption failed catastrophically, creating a "Hull" or "Blob" of False Positives.
- The model successfully learned this incorrect "Blob" distribution, leading to the visual artifacts.

### Solution
- **Abandon Heuristic**: The speed gain is not worth the corrupted data.
- **Adopt Accurate SDF**: Switch to `mesh_to_sdf` (or robust Ray Casting) for ALL points (Volume and Near). 
- **Action**: Rewrite `prepare_data.py` to ensure mathematical correctness of Inside/Outside labels.


## 11. Phase 1 å¤±è´¥åˆ†æä¸æ•°æ®ç”Ÿæˆä¿®æ­£ (Failure Analysis & Data Generation Pivot) [Dec 9, 2025]

### 11.1 ç—‡çŠ¶ä¸ç°è±¡
- **è®­ç»ƒæŒ‡æ ‡è¯¯å¯¼**: æ¨¡å‹è®­ç»ƒ IoU æŒ‡æ ‡è¾¾åˆ° ~0.70ï¼Œç”± `engine_ae.py` æŠ¥å‘Šï¼Œçœ‹ä¼¼è‰¯å¥½ã€‚
- **å¯è§†åŒ–ç¾éš¾**: ä½¿ç”¨ `infer_visualize.py` ç”Ÿæˆçš„ 3D åˆ‡ç‰‡å›¾æ˜¾ç¤ºé¢„æµ‹ç»“æœå‘ˆ "Blob" çŠ¶ï¼ˆä¸€å›¢æ¨¡ç³Šï¼‰ï¼Œä¸”å¤§é‡æº¢å‡ºåˆ°èƒŒæ™¯åŒºåŸŸã€‚
- **æŒ‡æ ‡å·®å¼‚**: 
  - Training/Validation IoU: ~0.70
  - Inference 3D IoU (on visual grid): ~0.10 - 0.15
  - è¿™ç§å·¨å¤§çš„ Gap è¡¨æ˜è®­ç»ƒæŒ‡æ ‡å’ŒçœŸå®å‡ ä½•æ€§èƒ½ä¹‹é—´å­˜åœ¨æ ¹æœ¬æ€§è„±èŠ‚ã€‚

### 11.2 æ ¹å› è°ƒæŸ¥ (Forensic Investigation)
- **æ­¥éª¤ 1**: æ€€ç–‘ `infer_visualize.py` çš„å½’ä¸€åŒ–å‚æ•°è®¡ç®—æœ‰è¯¯ã€‚
  - **éªŒè¯**: ä¿®å¤ä»£ç ï¼Œä½¿å…¶é€»è¾‘ä¸ `prepare_data.py` ä¸€è‡´ï¼ˆä»…ä½¿ç”¨å­˜åœ¨çš„ç±»åˆ«è®¡ç®— bboxï¼‰ã€‚ç»“æœï¼šä»£ç é€»è¾‘æ­£ç¡®ï¼Œä½†å¯è§†åŒ–ä¾ç„¶æ˜¯ä¸€å›¢ç³Ÿã€‚
- **æ­¥éª¤ 2**: æ€€ç–‘æ˜¯æ¨¡å‹è¿‡æ‹Ÿåˆæˆ–æ¬ æ‹Ÿåˆã€‚
  - **éªŒè¯**: æ£€æŸ¥ Epoch å†å²ï¼ŒIoU åˆ†æ•°å¾ˆé«˜ã€‚
- **æ­¥éª¤ 3 (å…³é”®çªç ´)**: æ€€ç–‘**è®­ç»ƒæ•°æ®æœ¬èº«å°±æ˜¯é”™çš„**ã€‚
  - **è¡ŒåŠ¨**: ä¿®æ”¹ `infer_visualize.py`ï¼Œå°†è®­ç»ƒç”¨çš„ `.npz` æ–‡ä»¶ä¸­çš„ Volume Pointsï¼ˆåŠæ ‡ç­¾ï¼‰ç›´æ¥å åŠ åˆ° Ground Truth åˆ‡ç‰‡ä¸Šã€‚
  - **ç»“æœ**: 
    - **ç™½è‰²ç‚¹ (Surface)**: å®Œç¾è´´åˆå™¨å®˜è½®å»“ï¼Œè¯´æ˜å‡ ä½•é‡‡æ ·æ²¡é—®é¢˜ã€‚
    - **å“çº¢è‰²ç‚¹ (Labeled Inside)**: **ä¸¥é‡å¼‚å¸¸**ã€‚å¤§é‡æ ‡è®°ä¸º "Inside" çš„ç‚¹å®é™…ä¸Šä½äºèƒŒæ™¯ç©ºæ°”ä¸­ï¼Œç”šè‡³å¡«æ»¡äº†æ•´ä¸ªåŒ…å›´ç›’ã€‚
  - **ç»“è®º**: æ¨¡å‹æ²¡æœ‰å­¦é”™ï¼Œå®ƒå¿ å®åœ°å­¦ä¹ äº†é”™è¯¯çš„æ ‡ç­¾ã€‚è®­ç»ƒæ•°æ®å°†å¤§é‡èƒŒæ™¯ç©ºæ°”é”™è¯¯æ ‡è®°ä¸ºäº†å™¨å®˜å†…éƒ¨ã€‚

### 11.3 æ ¹æœ¬åŸå›  (Root Cause)
- **Heuristic ç®—æ³•å¤±æ•ˆ**: ä¸ºäº†è¿½æ±‚é€Ÿåº¦ï¼Œä¸Šä¸€ç‰ˆ `prepare_data.py` ä½¿ç”¨äº† "Depth Ratio" (è·ç¦»æ¯”) å¯å‘å¼ç®—æ³•æ¥ç”Ÿæˆ Volume Points æ ‡ç­¾ã€‚
- **å‡è®¾å±€é™**: è¯¥ç®—æ³•å‡è®¾ç‰©ä½“æ˜¯ç®€å•çš„å‡¸åŒ…çŠ¶ï¼Œè¶Šé è¿‘ä¸­å¿ƒè¶Šå¯èƒ½æ˜¯å†…éƒ¨ã€‚å¯¹äº**å¤šç±»å¿ƒè„ç»“æ„**ï¼ˆåŒ…å«å¤šä¸ªå¿ƒæˆ¿å¿ƒå®¤ã€ä¸”æœ‰å¤æ‚å‡¹é™·ç»“æ„ï¼‰ï¼Œè¿™ä¸€å‡è®¾å®Œå…¨ç ´äº§ã€‚
- **åæœ**: ç®—æ³•å°†å‡¹é™·åŒºåŸŸçš„å¤–éƒ¨ç©ºé—´å…¨éƒ¨è¯¯åˆ¤ä¸ºå†…éƒ¨ï¼Œç”Ÿæˆäº† "Blob" çŠ¶çš„ Ground Truthï¼Œå¯¼è‡´æ¨¡å‹å‘ç”Ÿ Mode Collapseã€‚

### 11.4 è§£å†³æ–¹æ¡ˆ (The Fix)
- **æ”¾å¼ƒé€Ÿåº¦ï¼Œè¿½æ±‚æ­£ç¡®**: å½»åº•åºŸå¼ƒ Heuristic ç®—æ³•ã€‚
- **å…¨é¢é‡‡ç”¨ MeshToSDF**: 
  - æ‰€æœ‰ç‚¹ï¼ˆVolume Points å’Œ Near Pointsï¼‰å‡ä½¿ç”¨ `mesh_to_sdf` åº“è¿›è¡Œè®¡ç®—ã€‚
  - è¯¥åº“åŸºäº Ray Casting å’Œ KDTreeï¼Œèƒ½å‡†ç¡®åˆ¤æ–­å¤æ‚å‡ ä½•çš„ Inside/Outsideã€‚
- **é‡å†™ `prepare_data.py`**:
  - ç§»é™¤äº†æ‰€æœ‰ Heuristic ç›¸å…³å‡½æ•°ã€‚
  - å®ç°äº†å¹¶è¡ŒåŒ–çš„ `compute_accurate_sdf_single_batch`ã€‚
  - é’ˆå¯¹æ¯ä¸ªç±»åˆ«åˆ†åˆ«è®¡ç®—ç²¾ç¡® SDFï¼Œå†è¿›è¡Œåˆå¹¶ã€‚

### 11.5 åç»­è®¡åˆ’
1.  **é‡æ–°ç”Ÿæˆæ•°æ®**: ä½¿ç”¨æ–°è„šæœ¬ `prepare_data.py` ç”Ÿæˆ 998 ä¸ªæ ·æœ¬ã€‚é¢„è®¡è€—æ—¶è¾ƒé•¿ä½†è´¨é‡æœ‰ä¿è¯ã€‚
2.  **éªŒè¯**: ç”Ÿæˆéƒ¨åˆ†æ•°æ®åç«‹å³ä½¿ç”¨ `visualize_npz.py` (éœ€ç¼–å†™) æˆ–ç›´æ¥çœ‹ç‚¹äº‘åˆ†å¸ƒï¼Œç¡®è®¤ Inside/Outside æ ‡ç­¾æ­£ç¡®ã€‚
3.  **é‡è®­**: ä½¿ç”¨æ­£ç¡®çš„æ•°æ®é‡æ–°è¿›è¡Œ Phase 1 è®­ç»ƒã€‚



## 12. Headless Cluster Fix - Trimesh-Based SDF (Dec 9, 2025)

### 12.1 Problem: mesh_to_sdf Requires Display

**Error**:
```
pyglet.display.xlib.NoSuchDisplayException: Cannot connect to "None"
```

**Root Cause**:
- `mesh_to_sdf` library uses `pyrender` for sign detection
- `pyrender` creates OpenGL context via `pyglet.window.Window`
- This requires X11 display server (not available on headless cluster)

**Failed Attempts**:
1. **rtree method**: Too slow (333 days estimated) âŒ
2. **Heuristic depth-ratio**: Fast but incorrect (blob artifacts) âŒ  
3. **mesh_to_sdf**: Accurate but needs display âŒ

### 12.2 Solution: Pure Trimesh SDF

**Implementation**: Replace all `mesh_to_sdf` calls with `trimesh.proximity.signed_distance`

**Advantages**:
- âœ… Headless-safe (pure numpy/scipy, no rendering)
- âœ… Accurate ray-casting for inside/outside detection
- âœ… Built-in batching support
- âœ… Already installed (part of trimesh package)

**Key Function**:
```python
def compute_trimesh_sdf_batched(query_points, mesh, batch_size=10000):
    """
    Uses trimesh.proximity.signed_distance:
    - KDTree for nearest surface point (unsigned distance)
    - Ray casting for sign determination
    - Returns: negative (inside), positive (outside)
    """
    n_points = len(query_points)
    sdf = np.zeros(n_points, dtype=np.float32)
    
    for i in range(0, n_points, batch_size):
        batch = query_points[i:i+batch_size]
        sdf[i:i+batch_size] = trimesh.proximity.signed_distance(mesh, batch)
    
    return sdf
```

### 12.3 Changes Made

**File**: `prepare_data.py`

1. **Removed**: `mesh_to_sdf` import and availability check
2. **Replaced**: `compute_accurate_sdf_single_batch()` â†’ `compute_trimesh_sdf_batched()`
3. **Replaced**: `compute_high_quality_sdf()` â†’ `compute_trimesh_sdf_batched()`
4. **Updated**: All 4 call sites (Vol SDF parallel, Vol SDF sequential, Near SDF union, Near SDF per-class)
5. **Added**: Headless-safe batch processing with configurable batch size (default 10k)

**Modified Lines**: 13-20, 41-100, 105-109, 273-277, 302-305, 325-329, 385-389

### 12.4 Testing Protocol

**Step 1**: Test on single file
```bash
sbatch test_headless_data.sh
```
Expected: âœ… No display errors, completes in ~2-5 min

**Step 2**: Quality verification
```bash
python check_data_quality.py /scratch/.../test_trimesh_npz
```
Expected metrics:
- Vol SDF positive: 40-60%
- Near SDF positive: 45-55%
- Mean SDF â‰ˆ 0

**Step 3**: Visual inspection
```bash
python check_data_visualize.py --index 0 --npz_dir ... --gt_dir ...
```
Expected:
- Magenta points (inside) ONLY inside organs âœ…
- Blue points (outside) in background âœ…
- No blob artifacts âœ…

**Step 4**: Full dataset generation
```bash
sbatch sbatch_gen_trimesh_data.sh
```
Expected time: 3-8 hours (998 files)

### 12.5 Performance Estimates

| Method | Per File | Total (998 files) | Quality |
|--------|----------|-------------------|---------|
| mesh_to_sdf | N/A | âŒ Display error | Perfect |
| rtree + trimesh.contains | 30-60 min | 333 days | Perfect |
| Heuristic depth-ratio | \<1 min | 1.5 hours | âŒ Blob artifacts |
| **trimesh.proximity.signed_distance** | **2-5 min** | **3-8 hours** â­ | **Accurate** âœ… |

### 12.6 Key Improvements

1. **Headless Compatible**: Works on any cluster without X11
2. **Mathematically Correct**: Ray-casting based sign detection
3. **Reasonable Speed**: 100k points in 2-5 min (batched)
4. **Memory Efficient**: 10k batch size prevents OOM on 480GB nodes
5. **Parallel Ready**: Supports both file-level and point-level parallelization

### 12.7 Next Steps

1. âœ… Test single file generation
2. âœ… Verify data quality metrics
3. âœ… Visual inspection (no blobs)
4. â³ Full dataset generation (998 files)
5. â³ Update CSV files
6. â³ Resume Phase 1 training with correct data

**Status**: Ready for cluster testing

## 13. Phase 1 æ•°æ®é›†ç”Ÿæˆä¼˜åŒ–ä¸é‡äº§ (Fast Voxel-based Generation) [Dec 9, 2025]

### 13.1 èƒŒæ™¯ä¸æŒ‘æˆ˜
- **é€Ÿåº¦ææ…¢**: åŸæ–¹æ¡ˆä¾èµ–äº Mesh Ray-casting (ä½¿ç”¨äº† )ã€‚è™½ç„¶ç²¾åº¦é«˜ï¼Œä½†å¯¹äºé«˜åˆ†è¾¨ç‡åŒ»å­¦å›¾åƒï¼Œå•æ–‡ä»¶å¤„ç†è€—æ—¶è¿‡é•¿ï¼ˆæ•°åˆ†é’Ÿè‡³æ•°ååˆ†é’Ÿï¼‰ï¼Œæ— æ³•æ»¡è¶³å¤§è§„æ¨¡ç”Ÿæˆéœ€æ±‚ã€‚
- **å¯è§†åŒ–è¯¯å¯¼**: éªŒè¯è„šæœ¬ç”Ÿæˆçš„å›¾åƒè¾¹ç¼˜ç²—ç³™ï¼Œå¼•å‘äº†å¯¹æ•°æ®ç²¾åº¦çš„ä¸å¿…è¦æ‹…å¿§ã€‚
- **SDF åˆ†å¸ƒä¸å‡**: æ—©æœŸç”Ÿæˆçš„ Volume Points å’Œ Near Points çš„ SDF æ­£è´Ÿæ¯”ä¾‹ä¸¥é‡å¤±è¡¡ï¼Œä¸åˆ©äºæ¨¡å‹å­¦ä¹ å†…éƒ¨ç»“æ„ã€‚

### 13.2 æ ¸å¿ƒç®—æ³•é‡æ„ï¼šVoxel-based EDT
ä¸ºäº†å½»åº•è§£å†³é€Ÿåº¦ç“¶é¢ˆï¼Œæˆ‘ä»¬å¼•å…¥äº†åŸºäºä½“ç´ çš„æ¬§æ°è·ç¦»å˜æ¢ (Euclidean Distance Transform) æ–¹æ¡ˆã€‚

- **ç®—æ³•åŸç†**:
  - æ”¾å¼ƒå¯¹ Mesh çš„å…‰çº¿æŠ•å°„ã€‚
  - ç›´æ¥å¯¹ 3D äºŒå€¼ Mask è¿›è¡Œ ã€‚
  - åˆ†åˆ«è®¡ç®—â€œå†…éƒ¨è·ç¦»åœºâ€ () å’Œâ€œå¤–éƒ¨è·ç¦»åœºâ€ ()ã€‚
  - ç»„åˆå¾—åˆ° SDF: ã€‚
  - å¯¹äºä»»æ„å®æ•°åæ ‡ç‚¹ï¼Œä½¿ç”¨**ä¸‰çº¿æ€§æ’å€¼ (Trilinear Interpolation)** ä» SDF Grid ä¸­è·å–å€¼ã€‚
- **æ€§èƒ½é£è·ƒ**:
  - å¤æ‚åº¦ä» (N \times M)$ (ç‚¹æ•° $\times$ é¢ç‰‡æ•°) é™ä½åˆ° (N)$ (ä»…ä¸ç½‘æ ¼å¤§å°æœ‰å…³)ã€‚
  - **å•æ–‡ä»¶å¤„ç†æ—¶é—´ä»å‡ åˆ†é’Ÿé™ä½åˆ°å‡ ç§’é’Ÿ**ã€‚
- **ç²¾åº¦éªŒè¯**: å¯¹äº 256Â³ åˆ†è¾¨ç‡çš„åŒ»å­¦å›¾åƒï¼Œä½“ç´ çº§ SDF çš„ç²¾åº¦å®Œå…¨æ»¡è¶³éšå¼ç¥ç»åœºçš„è®­ç»ƒéœ€æ±‚ã€‚

### 13.3 é‡‡æ ·ç­–ç•¥ä¼˜åŒ–ï¼šSDF Balance
ä¸ºäº†ç¡®ä¿æ¨¡å‹èƒ½å‡è¡¡å­¦ä¹ ç‰©ä½“å†…éƒ¨å’Œå¤–éƒ¨çš„å‡ ä½•ç‰¹å¾ï¼Œæˆ‘ä»¬å®æ–½äº†ä¸¥æ ¼çš„ 50/50 é‡‡æ ·ç­–ç•¥ã€‚

- **Volume Points (50/50)**:
  - **50% Inside**: å¼ºåˆ¶ä» Mask å†…éƒ¨çš„ä½“ç´ åæ ‡é‡‡æ ·ï¼Œå¹¶æ·»åŠ   çš„æŠ–åŠ¨ (Jitter) å°†å…¶è½¬åŒ–ä¸ºè¿ç»­ç©ºé—´åæ ‡ã€‚
  - **50% Global**: åœ¨æ•´ä¸ª  ç©ºé—´å†…è¿›è¡Œå‡åŒ€éšæœºé‡‡æ ·ï¼ˆä¸»è¦è¦†ç›–å¤–éƒ¨èƒŒæ™¯ï¼‰ã€‚
- **Near Points (50/50)**:
  - åˆ©ç”¨ Marching Cubes ç”Ÿæˆçš„è¡¨é¢æ³•çº¿ ()ã€‚
  - **50% Push Out**: {out} = P_{surf} + \epsilon \times N$
  - **50% Push In**: {in} = P_{surf} - \epsilon \times N$
- **æ”¶æ•›ç»“æœ**:
  - ç»è¿‡éªŒè¯ (by )ï¼š å’Œ  çš„æ¯”ä¾‹å‡ç¨³å®šåœ¨ **45% ~ 46%**ï¼Œè¾¾åˆ°äº†æä½³çš„å¹³è¡¡çŠ¶æ€ã€‚

### 13.4 å¯è§†åŒ–è´¨é‡ä¿®å¤
ç”¨æˆ·æ›¾åé¦ˆ  ç”Ÿæˆçš„å›¾åƒè¾¹ç¼˜å‘ˆé”¯é½¿çŠ¶ï¼ˆç²—ç³™ï¼‰ã€‚
- **åŸå› **: éªŒè¯è„šæœ¬é»˜è®¤ä½¿ç”¨ä½åˆ†è¾¨ç‡ (128x128) ç½‘æ ¼å’Œæœ€è¿‘é‚»æ’å€¼ã€‚
- **ä¿®å¤**: å°†åˆ†è¾¨ç‡æå‡è‡³ 256 () åï¼Œé”¯é½¿æ¶ˆå¤±ï¼Œå›¾åƒå¹³æ»‘ç»†è…»ï¼Œè¯å®æ•°æ®æœ¬èº«çš„å‡ ä½•ç²¾åº¦æ˜¯å®Œæ•´çš„ã€‚

### 13.5 é›†ç¾¤é‡äº§é…ç½®
ä¸º CSC é›†ç¾¤ç”Ÿæˆäº†æœ€ç»ˆçš„é‡äº§è„šæœ¬ ã€‚

- **åˆ†åŒº**:  (CPU ä¸“ç”¨)
- **èµ„æº**: 20 CPU Cores, 32GB RAM
- **å¹¶è¡Œ**:  (å……åˆ†åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿)
- **é¢„è®¡è€—æ—¶**: å…¨é‡æ•°æ®ç”Ÿæˆé¢„è®¡å¯åœ¨ 1-2 å°æ—¶å†…å®Œæˆã€‚

## 13. Phase 1 æ•°æ®é›†ç”Ÿæˆä¼˜åŒ–ä¸é‡äº§ (Fast Voxel-based Generation) [Dec 9, 2025]

### 13.1 èƒŒæ™¯ä¸æŒ‘æˆ˜
- **é€Ÿåº¦ææ…¢**: åŸæ–¹æ¡ˆä¾èµ–äº Mesh Ray-casting (ä½¿ç”¨äº† `trimesh.proximity.signed_distance`)ã€‚è™½ç„¶ç²¾åº¦é«˜ï¼Œä½†å¯¹äºé«˜åˆ†è¾¨ç‡åŒ»å­¦å›¾åƒï¼Œå•æ–‡ä»¶å¤„ç†è€—æ—¶è¿‡é•¿ï¼ˆæ•°åˆ†é’Ÿè‡³æ•°ååˆ†é’Ÿï¼‰ï¼Œæ— æ³•æ»¡è¶³å¤§è§„æ¨¡ç”Ÿæˆéœ€æ±‚ã€‚
- **å¯è§†åŒ–è¯¯å¯¼**: éªŒè¯è„šæœ¬ç”Ÿæˆçš„å›¾åƒè¾¹ç¼˜ç²—ç³™ï¼Œå¼•å‘äº†å¯¹æ•°æ®ç²¾åº¦çš„ä¸å¿…è¦æ‹…å¿§ã€‚
- **SDF åˆ†å¸ƒä¸å‡**: æ—©æœŸç”Ÿæˆçš„ Volume Points å’Œ Near Points çš„ SDF æ­£è´Ÿæ¯”ä¾‹ä¸¥é‡å¤±è¡¡ï¼Œä¸åˆ©äºæ¨¡å‹å­¦ä¹ å†…éƒ¨ç»“æ„ã€‚

### 13.2 æ ¸å¿ƒç®—æ³•é‡æ„ï¼šVoxel-based EDT
ä¸ºäº†å½»åº•è§£å†³é€Ÿåº¦ç“¶é¢ˆï¼Œæˆ‘ä»¬å¼•å…¥äº†åŸºäºä½“ç´ çš„æ¬§æ°è·ç¦»å˜æ¢ (Euclidean Distance Transform) æ–¹æ¡ˆã€‚

- **ç®—æ³•åŸç†**:
  - æ”¾å¼ƒå¯¹ Mesh çš„å…‰çº¿æŠ•å°„ã€‚
  - ç›´æ¥å¯¹ 3D äºŒå€¼ Mask è¿›è¡Œ `scipy.ndimage.distance_transform_edt`ã€‚
  - åˆ†åˆ«è®¡ç®—â€œå†…éƒ¨è·ç¦»åœºâ€ (`dist_in`) å’Œâ€œå¤–éƒ¨è·ç¦»åœºâ€ (`dist_out`)ã€‚
  - ç»„åˆå¾—åˆ° SDF: `sdf = dist_out - dist_in`ã€‚
  - å¯¹äºä»»æ„å®æ•°åæ ‡ç‚¹ï¼Œä½¿ç”¨**ä¸‰çº¿æ€§æ’å€¼ (Trilinear Interpolation)** ä» SDF Grid ä¸­è·å–å€¼ã€‚
- **æ€§èƒ½é£è·ƒ**:
  - å¤æ‚åº¦ä» $O(N \times M)$ (ç‚¹æ•° $\times$ é¢ç‰‡æ•°) é™ä½åˆ° $O(N)$ (ä»…ä¸ç½‘æ ¼å¤§å°æœ‰å…³)ã€‚
  - **å•æ–‡ä»¶å¤„ç†æ—¶é—´ä»å‡ åˆ†é’Ÿé™ä½åˆ°å‡ ç§’é’Ÿ**ã€‚
- **ç²¾åº¦éªŒè¯**: å¯¹äº 256Â³ åˆ†è¾¨ç‡çš„åŒ»å­¦å›¾åƒï¼Œä½“ç´ çº§ SDF çš„ç²¾åº¦å®Œå…¨æ»¡è¶³éšå¼ç¥ç»åœºçš„è®­ç»ƒéœ€æ±‚ã€‚

### 13.3 é‡‡æ ·ç­–ç•¥ä¼˜åŒ–ï¼šSDF Balance
ä¸ºäº†ç¡®ä¿æ¨¡å‹èƒ½å‡è¡¡å­¦ä¹ ç‰©ä½“å†…éƒ¨å’Œå¤–éƒ¨çš„å‡ ä½•ç‰¹å¾ï¼Œæˆ‘ä»¬å®æ–½äº†ä¸¥æ ¼çš„ 50/50 é‡‡æ ·ç­–ç•¥ã€‚

- **Volume Points (50/50)**:
  - **50% Inside**: å¼ºåˆ¶ä» Mask å†…éƒ¨çš„ä½“ç´ åæ ‡é‡‡æ ·ï¼Œå¹¶æ·»åŠ  `[-0.5, 0.5]` çš„æŠ–åŠ¨ (Jitter) å°†å…¶è½¬åŒ–ä¸ºè¿ç»­ç©ºé—´åæ ‡ã€‚
  - **50% Global**: åœ¨æ•´ä¸ª `[-1, 1]` ç©ºé—´å†…è¿›è¡Œå‡åŒ€éšæœºé‡‡æ ·ï¼ˆä¸»è¦è¦†ç›–å¤–éƒ¨èƒŒæ™¯ï¼‰ã€‚
- **Near Points (50/50)**:
  - åˆ©ç”¨ Marching Cubes ç”Ÿæˆçš„è¡¨é¢æ³•çº¿ (`surface_normals`)ã€‚
  - **50% Push Out**: $P_{out} = P_{surf} + \epsilon \times N$
  - **50% Push In**: $P_{in} = P_{surf} - \epsilon \times N$
- **æ”¶æ•›ç»“æœ**:
  - ç»è¿‡éªŒè¯ (by `check_data_quality.py`)ï¼š`Vol+` å’Œ `Near+` çš„æ¯”ä¾‹å‡ç¨³å®šåœ¨ **45% ~ 46%**ï¼Œè¾¾åˆ°äº†æä½³çš„å¹³è¡¡çŠ¶æ€ã€‚

### 13.4 å¯è§†åŒ–è´¨é‡ä¿®å¤
ç”¨æˆ·æ›¾åé¦ˆ `check_data_visualize.py` ç”Ÿæˆçš„å›¾åƒè¾¹ç¼˜å‘ˆé”¯é½¿çŠ¶ï¼ˆç²—ç³™ï¼‰ã€‚
- **åŸå› **: éªŒè¯è„šæœ¬é»˜è®¤ä½¿ç”¨ä½åˆ†è¾¨ç‡ (128x128) ç½‘æ ¼å’Œæœ€è¿‘é‚»æ’å€¼ã€‚
- **ä¿®å¤**: å°†åˆ†è¾¨ç‡æå‡è‡³ 256 (`--resolution 256`) åï¼Œé”¯é½¿æ¶ˆå¤±ï¼Œå›¾åƒå¹³æ»‘ç»†è…»ï¼Œè¯å®æ•°æ®æœ¬èº«çš„å‡ ä½•ç²¾åº¦æ˜¯å®Œæ•´çš„ã€‚

### 13.5 é›†ç¾¤é‡äº§é…ç½®
ä¸º CSC é›†ç¾¤ç”Ÿæˆäº†æœ€ç»ˆçš„é‡äº§è„šæœ¬ `/home/user/persistent/VecsetX/gen_data_sbatch.sh`ã€‚

- **åˆ†åŒº**: `small` (CPU ä¸“ç”¨)
- **èµ„æº**: 20 CPU Cores, 32GB RAM
- **å¹¶è¡Œ**: `file_workers=20` (å……åˆ†åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿)
- **é¢„è®¡è€—æ—¶**: å…¨é‡æ•°æ®ç”Ÿæˆé¢„è®¡å¯åœ¨ 1-2 å°æ—¶å†…å®Œæˆã€‚
